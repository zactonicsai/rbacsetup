<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Azure AD + Keycloak Federation ‚Äî Complete Guide</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            display: ['Outfit', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
            accent: ['Space Mono', 'monospace'],
          },
          colors: {
            brand: {
              50: '#eefbfa',
              100: '#d5f5f3',
              200: '#b0eae8',
              300: '#7ad9d8',
              400: '#44c0c2',
              500: '#28a5a8',
              600: '#1f858b',
              700: '#1e6b71',
              800: '#1e565c',
              900: '#1d484e',
              950: '#0c2d33',
            },
            surface: {
              50: '#f8f9fb',
              100: '#f0f1f5',
              200: '#e4e6ed',
              700: '#1e2230',
              800: '#151824',
              900: '#0e1019',
              950: '#080a10',
            }
          }
        }
      }
    }
  </script>
  <style>
    /* === CUSTOM STYLES === */
    * { box-sizing: border-box; }
    body { font-family: 'Outfit', sans-serif; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #28a5a8; border-radius: 100px; }

    /* Progress bar at top */
    #progress-bar {
      position: fixed; top: 0; left: 0; height: 3px; z-index: 9999;
      background: linear-gradient(90deg, #28a5a8, #44c0c2, #7ad9d8);
      transition: width 0.15s ease-out;
    }

    /* Code blocks */
    .code-block {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.7;
      tab-size: 2;
    }

    /* Deep dive sections */
    .deep-dive-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
      opacity: 0;
    }
    .deep-dive-content.expanded {
      max-height: 8000px;
      opacity: 1;
    }

    /* TOC active state */
    .toc-link.active {
      color: #28a5a8;
      border-left-color: #28a5a8;
      background: rgba(40, 165, 168, 0.08);
    }
    .dark .toc-link.active {
      background: rgba(40, 165, 168, 0.12);
    }

    /* Animated background pattern */
    .hero-pattern {
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(40, 165, 168, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(68, 192, 194, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 60% 80%, rgba(122, 217, 216, 0.05) 0%, transparent 50%);
    }
    .dark .hero-pattern {
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(40, 165, 168, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(68, 192, 194, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 60% 80%, rgba(122, 217, 216, 0.08) 0%, transparent 50%);
    }

    /* Phase badge pulse */
    @keyframes badge-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(40, 165, 168, 0.3); }
      50% { box-shadow: 0 0 0 6px rgba(40, 165, 168, 0); }
    }
    .phase-badge { animation: badge-pulse 3s infinite; }

    /* Fade-in on scroll */
    .fade-section {
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.7s ease, transform 0.7s ease;
    }
    .fade-section.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Architecture diagram node animation */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .arch-node { animation: float 4s ease-in-out infinite; }
    .arch-node:nth-child(2) { animation-delay: 0.8s; }
    .arch-node:nth-child(3) { animation-delay: 1.6s; }

    /* Button glow on hover */
    .btn-glow:hover {
      box-shadow: 0 0 20px rgba(40, 165, 168, 0.35);
    }

    /* Checklist items */
    .check-item input:checked + span {
      text-decoration: line-through;
      opacity: 0.5;
    }

    /* Access matrix table */
    .access-matrix td, .access-matrix th {
      padding: 8px 10px;
      text-align: center;
      font-size: 0.78rem;
    }

    /* Smooth section reveal */
    .section-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .section-card:hover {
      transform: translateY(-2px);
    }

    /* Mobile TOC */
    #mobile-toc {
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #mobile-toc.open { transform: translateX(0); }

    /* ===== DARK MODE DEEP DIVE FIXES ===== */
    .dark .deep-dive-panel {
      background: rgba(14, 16, 25, 0.7) !important;
      border-color: rgba(255, 255, 255, 0.1) !important;
      backdrop-filter: blur(8px);
    }
    .dark .deep-dive-panel h4 {
      color: #e2e8f0 !important;
    }
    .dark .deep-dive-panel p,
    .dark .deep-dive-panel li,
    .dark .deep-dive-panel span:not(.shrink-0) {
      color: #cbd5e1 !important;
    }
    .dark .deep-dive-panel strong {
      color: #f1f5f9 !important;
    }
    .dark .deep-dive-panel code {
      background: rgba(255, 255, 255, 0.1) !important;
      color: #93c5fd !important;
    }
    .dark .deep-dive-panel .inner-block {
      background: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(255, 255, 255, 0.08) !important;
    }
    .dark .deep-dive-panel pre {
      color: #a5b4fc !important;
    }

    /* Deep dive accent bars per phase */
    .deep-dive-panel { position: relative; overflow: hidden; }
    .deep-dive-panel::before {
      content: '';
      position: absolute; top: 0; left: 0; bottom: 0; width: 3px;
    }
    .deep-dive-panel[data-accent="brand"]::before { background: #28a5a8; }
    .deep-dive-panel[data-accent="blue"]::before { background: #3b82f6; }
    .deep-dive-panel[data-accent="violet"]::before { background: #8b5cf6; }
    .deep-dive-panel[data-accent="emerald"]::before { background: #10b981; }
    .deep-dive-panel[data-accent="rose"]::before { background: #f43f5e; }
    .deep-dive-panel[data-accent="amber"]::before { background: #f59e0b; }
    .deep-dive-panel[data-accent="indigo"]::before { background: #6366f1; }

    /* Download buttons */
    .dl-btn {
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'Outfit', sans-serif; font-weight: 600;
      font-size: 0.75rem; padding: 6px 14px;
      border-radius: 10px; border: 1px solid;
      transition: all 0.25s ease; cursor: pointer;
      background: transparent;
    }
    .dl-btn:hover { transform: translateY(-1px); }
    .dl-btn-section {
      color: #64748b; border-color: #e2e8f0;
    }
    .dl-btn-section:hover {
      color: #28a5a8; border-color: #28a5a8; background: rgba(40, 165, 168, 0.06);
    }
    .dark .dl-btn-section {
      color: #94a3b8; border-color: #334155;
    }
    .dark .dl-btn-section:hover {
      color: #5eead4; border-color: #5eead4; background: rgba(94, 234, 212, 0.08);
    }
    .dl-btn-all {
      color: #fff; border-color: transparent;
      background: linear-gradient(135deg, #28a5a8, #1e6b71);
      box-shadow: 0 2px 12px rgba(40, 165, 168, 0.3);
    }
    .dl-btn-all:hover {
      box-shadow: 0 4px 20px rgba(40, 165, 168, 0.45);
    }

    /* Download spinner */
    @keyframes dl-spin { to { transform: rotate(360deg); } }
    .dl-spinner {
      width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%;
      animation: dl-spin 0.6s linear infinite; display: none;
    }
    .dl-btn.loading .dl-spinner { display: block; }
    .dl-btn.loading .dl-icon { display: none; }
  </style>

  <!-- DOCX generation libraries -->
  <script src="https://unpkg.com/docx@9.0.2/build/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-surface-50 text-surface-900 dark:bg-surface-950 dark:text-surface-100 transition-colors duration-300">

<!-- Progress Bar -->
<div id="progress-bar" style="width: 0%"></div>

<!-- ===== NAVBAR ===== -->
<nav class="fixed top-0 left-0 right-0 z-50 backdrop-blur-xl bg-white/80 dark:bg-surface-950/80 border-b border-surface-200/60 dark:border-surface-700/40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 flex items-center justify-between h-16">
    <div class="flex items-center gap-3">
      <!-- Mobile menu button -->
      <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
        </div>
        <span class="font-display font-bold text-lg hidden sm:block">Federation<span class="text-brand-500">Guide</span></span>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <span class="hidden md:inline text-xs font-mono text-surface-500 dark:text-surface-400 bg-surface-100 dark:bg-surface-800 px-2.5 py-1 rounded-full">v1.0</span>
      <!-- Theme toggle -->
      <button id="theme-toggle" class="relative w-14 h-7 rounded-full bg-surface-200 dark:bg-surface-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 dark:focus:ring-offset-surface-900" aria-label="Toggle dark mode">
        <div id="theme-knob" class="absolute top-0.5 left-0.5 w-6 h-6 rounded-full bg-white shadow-md transition-transform duration-300 flex items-center justify-center">
          <svg id="sun-icon" class="w-3.5 h-3.5 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
          <svg id="moon-icon" class="w-3.5 h-3.5 text-indigo-400 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
        </div>
      </button>
    </div>
  </div>
</nav>

<!-- ===== MOBILE TOC OVERLAY ===== -->
<div id="mobile-toc-overlay" class="fixed inset-0 bg-black/40 z-40 hidden lg:hidden" onclick="closeMobileToc()"></div>
<aside id="mobile-toc" class="fixed top-0 left-0 bottom-0 w-72 z-50 bg-white dark:bg-surface-900 shadow-2xl overflow-y-auto p-6 pt-20 lg:hidden">
  <div id="mobile-toc-links"></div>
</aside>

<!-- ===== HERO ===== -->
<header class="hero-pattern pt-28 pb-16 md:pt-36 md:pb-24 relative overflow-hidden">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 text-center relative z-10">
    <div class="inline-flex items-center gap-2 text-xs font-accent uppercase tracking-widest text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-950/50 border border-brand-200 dark:border-brand-800 px-4 py-1.5 rounded-full mb-6">
      <span class="w-1.5 h-1.5 rounded-full bg-brand-500 animate-pulse"></span>
      Complete Implementation Guide
    </div>
    <h1 class="font-display font-900 text-4xl sm:text-5xl md:text-6xl leading-tight tracking-tight mb-6">
      Azure AD <span class="text-brand-500">&</span> Keycloak<br class="hidden sm:block" />
      <span class="bg-gradient-to-r from-brand-500 via-brand-400 to-brand-600 bg-clip-text text-transparent">Federation with RBAC & SSO</span>
    </h1>
    <p class="text-lg md:text-xl text-surface-600 dark:text-surface-300 max-w-2xl mx-auto leading-relaxed font-light">
      Enterprise identity management from zero to production. Azure AD as your IdP, Keycloak as your broker, with role-based access control, classification-based clearance, need-to-know project approvals, and cell-level security.
    </p>

    <!-- Architecture Overview Diagram -->
    <div class="mt-12 flex flex-wrap justify-center items-center gap-4 md:gap-6">
      <div class="arch-node bg-white dark:bg-surface-800 border-2 border-blue-400 dark:border-blue-500 rounded-xl px-5 py-3 shadow-lg shadow-blue-500/10">
        <div class="text-[0.65rem] uppercase tracking-wider text-blue-500 font-accent mb-0.5">IdP</div>
        <div class="font-display font-bold text-sm">Azure AD</div>
      </div>
      <svg class="w-8 h-8 text-surface-400 dark:text-surface-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
      <div class="arch-node bg-white dark:bg-surface-800 border-2 border-brand-400 dark:border-brand-500 rounded-xl px-5 py-3 shadow-lg shadow-brand-500/10">
        <div class="text-[0.65rem] uppercase tracking-wider text-brand-500 font-accent mb-0.5">Broker</div>
        <div class="font-display font-bold text-sm">Keycloak</div>
      </div>
      <svg class="w-8 h-8 text-surface-400 dark:text-surface-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
      <div class="arch-node bg-white dark:bg-surface-800 border-2 border-emerald-400 dark:border-emerald-500 rounded-xl px-5 py-3 shadow-lg shadow-emerald-500/10">
        <div class="text-[0.65rem] uppercase tracking-wider text-emerald-500 font-accent mb-0.5">Apps</div>
        <div class="font-display font-bold text-sm">Your Services</div>
      </div>
    </div>

    <!-- Quick stat pills -->
    <div class="mt-10 flex flex-wrap justify-center gap-3 text-xs font-mono">
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">9 Phases</span>
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">20 Steps</span>
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">OIDC/OAuth2</span>
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">RBAC</span>
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">Cell-Level Security</span>
      <span class="bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 px-3 py-1.5 rounded-full">Need-to-Know</span>
    </div>

    <!-- Download buttons -->
    <div class="mt-8 flex flex-wrap justify-center gap-3">
      <button onclick="downloadAll(this)" class="dl-btn dl-btn-all">
        <div class="dl-spinner"></div>
        <svg class="dl-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Download Complete Guide (.docx)
      </button>
      <button onclick="downloadAll(this, true)" class="dl-btn dl-btn-section">
        <svg class="dl-icon w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
        Download by Sections (.docx)
      </button>
    </div>
    <!-- Deep dive toggle -->
    <label id="deep-dive-toggle" class="mt-4 inline-flex items-center gap-2.5 cursor-pointer select-none group">
      <span class="relative">
        <input type="checkbox" id="include-deep-dives" class="sr-only peer">
        <span class="block w-10 h-6 rounded-full bg-surface-200 dark:bg-surface-700 peer-checked:bg-brand-500 transition-colors duration-200"></span>
        <span class="absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white shadow-sm transition-transform duration-200 peer-checked:translate-x-4"></span>
      </span>
      <span class="text-sm font-display font-500 text-surface-600 dark:text-surface-300 group-hover:text-surface-900 dark:group-hover:text-surface-100 transition-colors">
        Include Deep Dives
      </span>
      <span class="text-xs text-surface-400 dark:text-surface-500 font-mono">(+30 pages)</span>
    </label>
  </div>
</header>

<!-- ===== MAIN LAYOUT ===== -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 pb-24">
  <div class="flex gap-8">

    <!-- SIDEBAR TOC (desktop) -->
    <aside id="desktop-toc" class="hidden lg:block w-64 shrink-0">
      <div class="sticky top-24 max-h-[calc(100vh-7rem)] overflow-y-auto pr-2 pb-8">
        <div class="text-[0.65rem] font-accent uppercase tracking-widest text-surface-400 dark:text-surface-500 mb-3 pl-3">Contents</div>
        <nav id="toc-nav" class="flex flex-col gap-0.5">
          <!-- JS will populate -->
        </nav>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 min-w-0">

      <!-- =============== SECTION: ARCHITECTURE OVERVIEW =============== -->
      <section id="architecture" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 flex items-center justify-center text-white text-lg">üèó</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Architecture Overview</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">The big picture</p>
            </div>
          </div>
          <p class="text-surface-600 dark:text-surface-300 leading-relaxed mb-6">
            This guide walks you through building an enterprise-grade identity and access management system. The architecture connects Microsoft's cloud identity platform with an open-source access management broker, giving you fine-grained control over who can access what in your applications.
          </p>

          <!-- Component cards -->
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-blue-500 text-lg mb-2">‚òÅÔ∏è</div>
              <h3 class="font-display font-bold text-sm mb-1">Azure AD (Entra ID)</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Primary Identity Provider ‚Äî authenticates users against Microsoft's cloud directory. Stores user accounts, group memberships, and organizational data.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-brand-500 text-lg mb-2">üîë</div>
              <h3 class="font-display font-bold text-sm mb-1">Keycloak</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Identity Broker & Policy Enforcement ‚Äî sits between Azure AD and your applications. Manages sessions, maps roles, and enforces fine-grained authorization.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-amber-500 text-lg mb-2">üîÑ</div>
              <h3 class="font-display font-bold text-sm mb-1">OIDC / OAuth 2.0</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Federation Protocol ‚Äî the industry-standard protocol connecting Azure AD to Keycloak. Handles token exchange, scopes, and secure redirects.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-emerald-500 text-lg mb-2">üõ°</div>
              <h3 class="font-display font-bold text-sm mb-1">RBAC</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Role-Based Access Control ‚Äî users are assigned roles (employee, manager, director, executive) that determine which actions they can perform.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-rose-500 text-lg mb-2">üî¨</div>
              <h3 class="font-display font-bold text-sm mb-1">Cell-Level Security</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Fine-grained data access via <strong>classification levels</strong> and <strong>need-to-know approval</strong> tied to project codes. Role alone does not grant access ‚Äî an executive without clearance and approved need-to-know is denied just like any other user.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-orange-500 text-lg mb-2">üè∑Ô∏è</div>
              <h3 class="font-display font-bold text-sm mb-1">Classification & Need-to-Know</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Data is tagged with a classification level and a project code. Users must hold the matching classification <em>and</em> an approved need-to-know for that project ‚Äî with CRUD permissions granted individually per approval.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/60 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <div class="text-violet-500 text-lg mb-2">üîó</div>
              <h3 class="font-display font-bold text-sm mb-1">SSO</h3>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Single Sign-On ‚Äî users authenticate once and gain access to all connected applications without re-entering credentials.</p>
            </div>
          </div>

          <!-- Deep Dive Button -->
          <button onclick="toggleDeepDive('arch-deep')" class="btn-glow inline-flex items-center gap-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: How the Flow Works
          </button>
          <div id="arch-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-brand-50 dark:bg-surface-800 border border-brand-200 dark:border-brand-800/60 rounded-xl p-6 pl-7" data-accent="brand">
              <h4 class="font-display font-bold text-lg text-brand-700 dark:text-brand-300 mb-3">üîÑ Authentication Flow Step-by-Step</h4>
              <div class="space-y-3 text-sm text-surface-700 dark:text-surface-300 leading-relaxed">
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">1</span><p><strong>User visits your application</strong> ‚Äî The app detects no active session and redirects the user to Keycloak's login page.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">2</span><p><strong>Keycloak presents login options</strong> ‚Äî The user sees a "Sign in with Microsoft Azure AD" button (configured as an Identity Provider in Keycloak).</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">3</span><p><strong>Redirect to Azure AD</strong> ‚Äî Keycloak initiates an OIDC Authorization Code flow, redirecting the browser to Microsoft's login page with a client_id and redirect_uri.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">4</span><p><strong>User authenticates at Azure AD</strong> ‚Äî The user enters their Microsoft credentials (and MFA if configured). Azure AD validates the credentials.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">5</span><p><strong>Azure AD returns an authorization code</strong> ‚Äî On success, Azure AD redirects back to Keycloak's broker endpoint with an authorization code.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">6</span><p><strong>Keycloak exchanges the code for tokens</strong> ‚Äî Keycloak calls Azure AD's token endpoint using the code + client_secret, receiving an ID token, access token, and refresh token.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">7</span><p><strong>Keycloak processes claims and maps roles</strong> ‚Äî The ID token contains claims (email, name, groups). Keycloak's mappers extract these, create/update the local user, and assign Keycloak roles based on Azure AD group memberships.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">8</span><p><strong>Keycloak creates its own session & tokens</strong> ‚Äî Keycloak issues its own JWT access token enriched with realm roles, department attributes, and custom claims. This token is what your application actually validates.</p></div>
                <div class="flex gap-3"><span class="shrink-0 w-6 h-6 rounded-full bg-brand-500 text-white text-xs flex items-center justify-center font-bold">9</span><p><strong>Application enforces RBAC & cell-level security</strong> ‚Äî Your app reads the JWT, checks the user's roles and attributes, and grants/denies access to resources accordingly.</p></div>
              </div>
              <div class="mt-5 p-4 inner-block bg-white/60 dark:bg-surface-900/60 rounded-lg border border-brand-200/50 dark:border-white/10">
                <p class="text-xs font-mono text-surface-500 dark:text-surface-400"><strong class="text-brand-600 dark:text-brand-400">Key concept:</strong> Keycloak acts as a <em>broker</em> ‚Äî it federates identity from Azure AD but maintains its own sessions and tokens. This decouples your applications from any single identity provider, so you could add Google, Okta, or LDAP without changing application code.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 1: AZURE AD SETUP =============== -->
      <section id="phase1" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-500 text-white text-xs font-bold font-mono">P1</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Azure AD (Entra ID) Setup</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 1‚Äì6 ¬∑ Configure your cloud identity provider</p>

          <!-- Step 1 -->
          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 1</span>
              Create Azure AD Tenant
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Your Azure AD tenant is your organization's dedicated instance where all users, groups, and app registrations live. Navigate to <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">portal.azure.com</code>, go to <strong>Azure Active Directory ‚Üí Overview</strong>, and note your <strong>Tenant ID</strong> and <strong>Primary Domain</strong> (e.g., <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">yourcompany.onmicrosoft.com</code>).
            </p>
          </div>

          <!-- Step 2 -->
          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 2</span>
              Create Users and Groups
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Groups are the foundation of RBAC. Create groups that mirror your organizational roles and departments. Each group will later map to a Keycloak role.
            </p>
            <div class="grid sm:grid-cols-2 gap-2 text-xs font-mono">
              <div class="bg-surface-50 dark:bg-surface-900/40 rounded-lg px-3 py-2 border border-surface-200 dark:border-surface-700/40"><span class="text-emerald-500">‚óè</span> Admin-FullAccess</div>
              <div class="bg-surface-50 dark:bg-surface-900/40 rounded-lg px-3 py-2 border border-surface-200 dark:border-surface-700/40"><span class="text-blue-500">‚óè</span> Manager-ReadWrite</div>
              <div class="bg-surface-50 dark:bg-surface-900/40 rounded-lg px-3 py-2 border border-surface-200 dark:border-surface-700/40"><span class="text-amber-500">‚óè</span> User-ReadOnly</div>
              <div class="bg-surface-50 dark:bg-surface-900/40 rounded-lg px-3 py-2 border border-surface-200 dark:border-surface-700/40"><span class="text-rose-500">‚óè</span> Finance-Department</div>
              <div class="bg-surface-50 dark:bg-surface-900/40 rounded-lg px-3 py-2 border border-surface-200 dark:border-surface-700/40"><span class="text-violet-500">‚óè</span> HR-Department</div>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 3</span>
              Register Application in Azure AD
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              This creates the OAuth2/OIDC endpoint Keycloak uses for federation. Go to <strong>App Registrations ‚Üí New Registration</strong>, name it <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">Keycloak-Federation</code>, set the redirect URI to your Keycloak broker endpoint, and capture the <strong>Application (client) ID</strong> and <strong>Directory (tenant) ID</strong>.
            </p>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto">
              <pre>Redirect URI (Web):
http://localhost:8080/realms/master/broker/azuread/endpoint

Save these values:
‚îú‚îÄ‚îÄ Application (client) ID:  [GUID]
‚îú‚îÄ‚îÄ Directory (tenant) ID:    [GUID]
‚îî‚îÄ‚îÄ Primary Domain:           yourcompany.onmicrosoft.com</pre>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 4</span>
              Create Client Secret
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Keycloak needs credentials to authenticate to Azure AD. Go to <strong>Certificates & Secrets ‚Üí New Client Secret</strong>. Copy the secret <em>value</em> immediately ‚Äî you cannot retrieve it later. Set expiry to 24 months or per your security policy.
            </p>
            <div class="bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700/50 rounded-xl p-4 text-sm text-amber-800 dark:text-amber-200">
              ‚ö†Ô∏è <strong>Critical:</strong> Copy the secret VALUE immediately after creation. Azure AD will only show it once. Store it securely in a secrets manager.
            </div>
          </div>

          <!-- Step 5 -->
          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 5</span>
              Configure API Permissions
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Add Microsoft Graph delegated permissions so Keycloak can read user profiles and group memberships. Then grant admin consent for your organization.
            </p>
            <div class="flex flex-wrap gap-2 text-xs font-mono">
              <span class="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/40 px-3 py-1 rounded-full">openid</span>
              <span class="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/40 px-3 py-1 rounded-full">profile</span>
              <span class="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/40 px-3 py-1 rounded-full">email</span>
              <span class="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/40 px-3 py-1 rounded-full">User.Read</span>
              <span class="bg-emerald-50 dark:bg-emerald-950/30 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/40 px-3 py-1 rounded-full">GroupMember.Read.All</span>
            </div>
          </div>

          <!-- Step 6 -->
          <div class="mb-6">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-blue-500 bg-blue-50 dark:bg-blue-950/40 px-2 py-0.5 rounded">Step 6</span>
              Configure Token Claims
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Add optional claims (email, family_name, given_name) to the ID token, and enable group claims so Azure AD includes group memberships as Group IDs in tokens sent to Keycloak.
            </p>
          </div>

          <!-- Deep Dive -->
          <button onclick="toggleDeepDive('phase1-deep')" class="btn-glow inline-flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: Azure AD Concepts
          </button>
          <div id="phase1-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-blue-50 dark:bg-surface-800 border border-blue-200 dark:border-blue-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="blue">
              <div>
                <h4 class="font-display font-bold text-blue-700 dark:text-blue-300 mb-1">What is a Tenant?</h4>
                <p>A tenant is a dedicated, isolated instance of Azure AD that an organization receives when it signs up for a Microsoft cloud service. Think of it as your organization's private directory in the cloud. Every user, group, and app registration lives within a specific tenant. The Tenant ID (a GUID) uniquely identifies it across all of Microsoft's infrastructure.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-blue-700 dark:text-blue-300 mb-1">App Registrations vs. Enterprise Applications</h4>
                <p><strong>App Registration</strong> defines the identity configuration ‚Äî client ID, secrets, redirect URIs, and permissions. It's the "blueprint." An <strong>Enterprise Application</strong> is the instantiation of that blueprint within a tenant ‚Äî it controls who can use the app, conditional access policies, and sign-in logs. When you register an app, both are created automatically.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-blue-700 dark:text-blue-300 mb-1">Delegated vs. Application Permissions</h4>
                <p><strong>Delegated permissions</strong> are used when a signed-in user is present ‚Äî the app acts on behalf of the user and can only access what the user themselves can access. <strong>Application permissions</strong> are for background services with no signed-in user ‚Äî the app acts as itself with its own identity. For Keycloak federation, we use delegated permissions because users are actively signing in.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-blue-700 dark:text-blue-300 mb-1">Why Group Claims Matter</h4>
                <p>By including group Object IDs in the ID token, we avoid extra API calls to Microsoft Graph during login. Keycloak receives the group memberships directly in the token and can immediately map them to local roles. Without this, Keycloak would need to separately query the Graph API for each user's groups ‚Äî adding latency and complexity.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-blue-700 dark:text-blue-300 mb-1">Client Secret Security</h4>
                <p>The client secret is essentially the "password" for your app registration. In production, consider using <strong>certificates</strong> instead of secrets for stronger security. Store secrets in Azure Key Vault or your preferred secret management solution. Never commit them to source control. Set calendar reminders before expiry to rotate them.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 2: KEYCLOAK SETUP =============== -->
      <section id="phase2" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-brand-500 text-white text-xs font-bold font-mono">P2</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Keycloak Installation & Setup</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 7‚Äì8 ¬∑ Install and configure your identity broker</p>

          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-brand-500 bg-brand-50 dark:bg-brand-950/40 px-2 py-0.5 rounded">Step 7</span>
              Install Keycloak
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Download and extract Keycloak, set admin credentials via environment variables, then start in development mode. Access the admin console at <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">http://localhost:8080</code>.
            </p>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto">
              <pre><span class="text-surface-500"># Download &amp; extract</span>
wget https://github.com/keycloak/keycloak/releases/download/23.0.0/keycloak-23.0.0.zip
unzip keycloak-23.0.0.zip && cd keycloak-23.0.0

<span class="text-surface-500"># Set admin credentials</span>
export KEYCLOAK_ADMIN=admin
export KEYCLOAK_ADMIN_PASSWORD=admin123!

<span class="text-surface-500"># Start (dev mode)</span>
./bin/kc.sh start-dev

<span class="text-surface-500"># Or production mode</span>
./bin/kc.sh build
./bin/kc.sh start --hostname=localhost</pre>
            </div>
          </div>

          <div class="mb-6">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-brand-500 bg-brand-50 dark:bg-brand-950/40 px-2 py-0.5 rounded">Step 8</span>
              Create Keycloak Realm
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Realms are isolated tenants within Keycloak. Create a realm called <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">enterprise-apps</code>. Disable user registration (since users come from Azure AD) and enable "Remember me."
            </p>
          </div>

          <button onclick="toggleDeepDive('phase2-deep')" class="btn-glow inline-flex items-center gap-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: Keycloak Concepts
          </button>
          <div id="phase2-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-brand-50 dark:bg-surface-800 border border-brand-200 dark:border-brand-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="brand">
              <div>
                <h4 class="font-display font-bold text-brand-700 dark:text-brand-300 mb-1">Realms: Multi-Tenancy in Keycloak</h4>
                <p>A Realm is a space where you manage a set of users, credentials, roles, and groups. Realms are completely isolated from each other. The <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">master</code> realm is a special admin realm ‚Äî you should create separate realms for your applications. Think of each realm like a separate Keycloak installation.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-brand-700 dark:text-brand-300 mb-1">Dev Mode vs. Production Mode</h4>
                <p><strong>Dev mode</strong> (<code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">start-dev</code>) uses an embedded H2 database, disables HTTPS requirement, and enables hot-reload. <strong>Production mode</strong> requires you to configure an external database (PostgreSQL recommended), set up TLS certificates, configure hostname, and build an optimized server. Never use dev mode in production ‚Äî the H2 database is not suitable for concurrent access.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-brand-700 dark:text-brand-300 mb-1">Why Keycloak as a Broker?</h4>
                <p>Using Keycloak as an identity broker gives you vendor independence. Your applications only need to know about Keycloak ‚Äî they never directly communicate with Azure AD. If you later need to switch identity providers, add LDAP federation, or support social logins, you only change Keycloak's configuration, not your application code. Keycloak also adds capabilities Azure AD alone doesn't provide, like fine-grained authorization services.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-brand-700 dark:text-brand-300 mb-1">Identity Provider vs. Identity Broker</h4>
                <p>An <strong>Identity Provider (IdP)</strong> authenticates users ‚Äî it's where credentials are verified (Azure AD in our case). An <strong>Identity Broker</strong> delegates authentication to external IdPs while managing its own sessions and token issuance. Keycloak is the broker: it doesn't verify passwords, but it manages the full lifecycle of user sessions, role mappings, and access tokens for your applications.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 3: FEDERATION =============== -->
      <section id="phase3" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-violet-500 text-white text-xs font-bold font-mono">P3</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Federation Configuration</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 9‚Äì10 ¬∑ Connect Azure AD to Keycloak via OIDC</p>

          <div class="mb-8">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-violet-500 bg-violet-50 dark:bg-violet-950/40 px-2 py-0.5 rounded">Step 9</span>
              Add Azure AD as Identity Provider
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              In Keycloak, add an OpenID Connect v1.0 identity provider with alias <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">azuread</code>. Point the discovery endpoint to Azure AD's well-known configuration URL, provide the Client ID and Secret from your app registration, and configure attribute mappers.
            </p>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto mb-4">
              <pre><span class="text-surface-500"># Discovery endpoint template</span>
https://login.microsoftonline.com/{TENANT_ID}/v2.0/.well-known/openid-configuration

<span class="text-surface-500"># Key settings</span>
Alias:          azuread
Client ID:      [from Azure AD App Registration]
Client Secret:  [from Azure AD]
Default Scopes: openid profile email
Sync Mode:      IMPORT
Trust Email:    ON</pre>
            </div>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
              Configure four attribute mappers: <strong>email</strong>, <strong>firstName</strong> (from <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">given_name</code>), <strong>lastName</strong> (from <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">family_name</code>), and <strong>azure-groups</strong> (from the <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">groups</code> claim).
            </p>
          </div>

          <div class="mb-6">
            <h3 class="font-display font-bold text-lg mb-2 flex items-center gap-2">
              <span class="text-xs font-mono text-violet-500 bg-violet-50 dark:bg-violet-950/40 px-2 py-0.5 rounded">Step 10</span>
              Update Azure AD Redirect URI
            </h3>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
              Copy the Redirect URI from Keycloak's identity provider settings and add it back in Azure AD's app registration under <strong>Authentication ‚Üí Redirect URIs</strong>. This completes the OAuth2 redirect flow loop.
            </p>
          </div>

          <button onclick="toggleDeepDive('phase3-deep')" class="btn-glow inline-flex items-center gap-2 bg-violet-500 hover:bg-violet-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: OIDC & Federation
          </button>
          <div id="phase3-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-violet-50 dark:bg-surface-800 border border-violet-200 dark:border-violet-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="violet">
              <div>
                <h4 class="font-display font-bold text-violet-700 dark:text-violet-300 mb-1">OIDC Discovery Endpoint</h4>
                <p>The <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">.well-known/openid-configuration</code> URL returns a JSON document describing all the endpoints (authorization, token, userinfo, JWKS), supported scopes, claims, and algorithms. Keycloak reads this once during setup, so it automatically knows where to send users for login, where to exchange codes for tokens, and where to find the public keys for JWT validation.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-violet-700 dark:text-violet-300 mb-1">Mappers: The Bridge Between Systems</h4>
                <p>Claim mappers are the critical translation layer. Azure AD tokens use specific claim names (e.g., <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">given_name</code>) while Keycloak uses different attribute names (e.g., <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">firstName</code>). Mappers extract values from incoming Azure AD tokens and write them to the correct Keycloak user attributes. Without proper mappers, user profiles would be incomplete and group-to-role mapping wouldn't work.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-violet-700 dark:text-violet-300 mb-1">Sync Mode: IMPORT vs. FORCE</h4>
                <p><strong>IMPORT</strong> creates the user on first login and doesn't update attributes on subsequent logins. <strong>FORCE</strong> updates user attributes from Azure AD on every login. Use FORCE for attributes you want to stay in sync (like groups and department), and IMPORT for attributes users might customize locally in Keycloak.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-violet-700 dark:text-violet-300 mb-1">The Redirect URI Dance</h4>
                <p>OAuth2 security relies on the redirect URI being exactly registered. The flow is: your app ‚Üí Keycloak login ‚Üí Azure AD login ‚Üí back to Keycloak (at the broker endpoint) ‚Üí back to your app. Both Keycloak and Azure AD must have each other's redirect URIs registered. A mismatch of even one character (trailing slash, http vs https) will cause a "redirect_uri_mismatch" error.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 4: RBAC =============== -->
      <section id="phase4" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-emerald-500 text-white text-xs font-bold font-mono">P4</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">RBAC Setup</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 11‚Äì12 ¬∑ Roles, composite roles, and group mapping</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Create Keycloak roles that define what users can do, then map Azure AD groups to those roles for automatic assignment.</p>

          <!-- Classification Notice -->
          <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/40 rounded-xl p-4 mb-6">
            <h4 class="font-display font-bold text-sm text-amber-700 dark:text-amber-300 mb-1">‚ö†Ô∏è Important: Roles Are Necessary But Not Sufficient</h4>
            <p class="text-xs text-amber-800 dark:text-amber-200 leading-relaxed">A role (employee, manager, director, executive) determines the <strong>maximum capability</strong> a user may exercise ‚Äî but it does <strong>not</strong> grant access to any classified data by itself. To see or modify classified data, a user must <em>also</em> hold the required <strong>classification level</strong> and an approved <strong>need-to-know</strong> for the specific project code. An executive who lacks classification clearance or need-to-know approval for a project is denied access to that project‚Äôs data, regardless of their role.</p>
          </div>

          <!-- Role hierarchy visualization -->
          <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-5 mb-6">
            <h4 class="font-display font-bold text-sm mb-3">Role Hierarchy (Composite Roles)</h4>
            <div class="code-block text-xs text-surface-700 dark:text-surface-300">
              <pre>admin (full access)
‚îî‚îÄ‚îÄ executive
    ‚îî‚îÄ‚îÄ director
        ‚îî‚îÄ‚îÄ manager
            ‚îî‚îÄ‚îÄ employee (base level)

<span class="text-brand-500">Composite = inherits all child roles</span>
A "director" automatically has manager + employee permissions

<span class="text-rose-500">‚úò Role ‚â† Access to classified data</span>
<span class="text-rose-500">Access = Role + Classification Level + Need-to-Know Approval</span>
An executive without NTK approval for Project-X cannot see Project-X data</pre>
            </div>
          </div>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Use <strong>Advanced Claim to Role</strong> mappers to automatically assign Keycloak roles based on Azure AD group Object IDs. For example, membership in the <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">Manager-ReadWrite</code> Azure AD group grants the <code class="text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded font-mono">manager</code> Keycloak role.</p>

          <button onclick="toggleDeepDive('phase4-deep')" class="btn-glow inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: RBAC Concepts
          </button>
          <div id="phase4-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-emerald-50 dark:bg-surface-800 border border-emerald-200 dark:border-emerald-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="emerald">
              <div>
                <h4 class="font-display font-bold text-emerald-700 dark:text-emerald-300 mb-1">Why Composite Roles?</h4>
                <p>Composite roles create an inheritance chain. Instead of assigning 15 individual permissions to a director, you assign one "director" role that automatically includes manager and employee permissions. This reduces administrative overhead and ensures consistency ‚Äî when you add a new base permission, every composite role above it inherits it automatically.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-emerald-700 dark:text-emerald-300 mb-1">Realm Roles vs. Client Roles</h4>
                <p><strong>Realm roles</strong> are global within a Keycloak realm ‚Äî they apply across all applications. <strong>Client roles</strong> are specific to a single application (client). For enterprise setups, use realm roles for organizational hierarchy (employee, manager, director) and client roles for application-specific permissions (can_edit_invoice, can_approve_order).</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-emerald-700 dark:text-emerald-300 mb-1">Role Composition in Detail</h4>
                <div class="code-block inner-block bg-white/60 dark:bg-surface-900/60 rounded-lg p-3 mt-2 border border-transparent dark:border-white/5">
                  <pre class="text-xs">employee: document:read, document:create, profile:read-own,
          profile:update-own, access-public, access-internal

manager:  ‚Üë employee + document:update, document:share,
          profile:read-team, access-confidential

director: ‚Üë manager + document:delete, profile:read-dept,
          access-restricted, admin:audit-logs

executive: ‚Üë director + profile:read-all, access-top-secret,
           admin:user-management</pre>
                </div>
              </div>
              <div>
                <h4 class="font-display font-bold text-emerald-700 dark:text-emerald-300 mb-1">Group-to-Role Mapping Strategy</h4>
                <p>The "Advanced Claim to Role" mapper watches for a specific Azure AD Group Object ID in the <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">groups</code> claim of the incoming token. When it finds a match, it assigns the corresponding Keycloak role. Set <strong>Sync Mode to FORCE</strong> so that if a user is removed from an Azure AD group, their Keycloak role is also removed on next login.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 5: APP INTEGRATION & CELL-LEVEL =============== -->
      <section id="phase5" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-rose-500 text-white text-xs font-bold font-mono">P5</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">App Integration & Cell-Level Security</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 13‚Äì15 ¬∑ Client config, scopes, and fine-grained access</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Register your application as a Keycloak client, configure client scopes to include roles in JWT tokens, then implement cell-level security using user attributes and Keycloak's Authorization Services.</p>

          <div class="grid sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-rose-50 dark:bg-rose-900/25 border border-rose-200 dark:border-rose-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm text-rose-700 dark:text-rose-300 mb-2">Layer 1: User Attributes & Classification</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Add <code class="font-mono">classification_level</code> (0‚Äì4) and <code class="font-mono">department</code> to each user. Map into access tokens via client scope mappers. The app compares the user‚Äôs level against the data‚Äôs classification before any access.</p>
            </div>
            <div class="bg-rose-50 dark:bg-rose-900/25 border border-rose-200 dark:border-rose-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm text-rose-700 dark:text-rose-300 mb-2">Layer 2: Need-to-Know + Project Code</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Even with sufficient clearance, users must have an <strong>approved need-to-know</strong> entry for a data item‚Äôs project code. Each NTK approval specifies exactly which CRUD operations are permitted. The app checks the <code class="font-mono">user_need_to_know</code> table for a matching project + allowed actions.</p>
            </div>
            <div class="bg-rose-50 dark:bg-rose-900/25 border border-rose-200 dark:border-rose-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm text-rose-700 dark:text-rose-300 mb-2">Layer 3: Authorization Services</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Define Resources, Scopes, Policies, and Permissions in Keycloak. Policies combine role checks, classification-level checks, and NTK lookups. Keycloak evaluates all policies at runtime and returns authorization decisions.</p>
            </div>
          </div>

          <button onclick="toggleDeepDive('phase5-deep')" class="btn-glow inline-flex items-center gap-2 bg-rose-500 hover:bg-rose-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: Cell-Level Security
          </button>
          <div id="phase5-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-rose-50 dark:bg-surface-800 border border-rose-200 dark:border-rose-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="rose">
              <div>
                <h4 class="font-display font-bold text-rose-700 dark:text-rose-300 mb-1">What Is Cell-Level Security?</h4>
                <p>Unlike RBAC (which controls what actions you can perform), cell-level security controls which specific data items you can see. A "manager" might have read access to documents, but cell-level security ensures they only see documents from their own department, not every department's documents. It's the difference between "can you read documents?" (RBAC) and "which documents can you read?" (cell-level).</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-rose-700 dark:text-rose-300 mb-1">Data Classification Levels & Need-to-Know</h4>
                <p>Documents are classified as <strong>Public</strong> (L0), <strong>Internal</strong> (L1), <strong>Confidential</strong> (L2), <strong>Restricted</strong> (L3), or <strong>Top-Secret</strong> (L4). Classification defines the <em>minimum clearance</em> a user must hold, but <strong>clearance alone is not enough</strong>. Access requires:</p>
                <div class="mt-2 space-y-1.5 text-xs">
                  <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500 font-bold">1.</span><p><strong>Classification Level:</strong> User‚Äôs clearance level ‚â• data‚Äôs classification level.</p></div>
                  <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500 font-bold">2.</span><p><strong>Need-to-Know Approval:</strong> User has an approved NTK entry for the data‚Äôs project code, granted by a project owner or security officer.</p></div>
                  <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500 font-bold">3.</span><p><strong>CRUD Permission:</strong> The NTK approval specifies exactly which operations (Create, Read, Update, Delete) the user may perform. A user may be approved to Read but not Update or Delete.</p></div>
                </div>
                <div class="mt-3 p-3 inner-block bg-white/60 dark:bg-surface-900/60 rounded-lg border border-rose-200/50 dark:border-white/10">
                  <p class="text-xs font-mono text-surface-500 dark:text-surface-400"><strong class="text-rose-600 dark:text-rose-400">Example:</strong> An <em>executive</em> (highest role) tries to access a <em>Restricted</em> financial forecast for <code>PROJECT-ATLAS</code>. They hold Top-Secret clearance (L4 ‚â• L3 ‚úî) but have <strong>no NTK approval</strong> for PROJECT-ATLAS ‚Äî <strong>access denied</strong>. Meanwhile, an <em>employee</em> who holds L3 clearance <em>and</em> has an approved NTK for PROJECT-ATLAS with Read permission <strong>can</strong> view it.</p>
                </div>
              </div>
              <div>
                <h4 class="font-display font-bold text-rose-700 dark:text-rose-300 mb-1">PostgreSQL Row-Level Security</h4>
                <p>For the deepest level of protection, use database-level row security. PostgreSQL's RLS policies automatically filter query results based on session variables set from the JWT token. Even if application code has a bug that skips a permission check, the database itself enforces the access rules ‚Äî it's defense in depth.</p>
                <div class="code-block inner-block bg-white/60 dark:bg-surface-900/60 rounded-lg p-3 mt-2 border border-transparent dark:border-white/5">
                  <pre class="text-xs"><span class="text-rose-400">-- Enable RLS on the table</span>
ALTER TABLE financial_records ENABLE ROW LEVEL SECURITY;

<span class="text-rose-400">-- Policy: users only see their department's rows</span>
CREATE POLICY dept_isolation ON financial_records
  USING (department = current_setting('app.user_department'));

<span class="text-rose-400">-- In app code: set the session variable from JWT</span>
await db.query(`SET app.user_department = $1`, [token.department]);</pre>
                </div>
              </div>
              <div>
                <h4 class="font-display font-bold text-rose-700 dark:text-rose-300 mb-1">Keycloak Authorization Services: Resources ‚Üí Policies ‚Üí Permissions</h4>
                <p><strong>Resources</strong> represent what you're protecting (e.g., <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">/api/finance/*</code>). <strong>Scopes</strong> define actions (view, edit, delete). <strong>Policies</strong> define the rules (must have role X, must be in department Y). <strong>Permissions</strong> tie them together: "Resource A + Scope B requires Policy C." The Decision Strategy (Affirmative = any policy passes, Unanimous = all must pass) controls how multiple policies combine.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 6: SSO =============== -->
      <section id="phase6" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-amber-500 text-white text-xs font-bold font-mono">P6</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Single Sign-On (SSO)</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Steps 16‚Äì17 ¬∑ Session settings and testing the flow</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Configure SSO session lifespans in Keycloak, set appropriate token lifetimes, then test the complete authentication flow end-to-end.</p>

          <div class="grid sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-xs uppercase tracking-wider text-amber-600 dark:text-amber-400 mb-2">Session Settings</h4>
              <div class="space-y-1.5 text-xs font-mono text-surface-600 dark:text-surface-400">
                <div class="flex justify-between"><span>SSO Session Idle</span><span class="text-surface-900 dark:text-surface-100">30 min</span></div>
                <div class="flex justify-between"><span>SSO Session Max</span><span class="text-surface-900 dark:text-surface-100">10 hrs</span></div>
                <div class="flex justify-between"><span>Remember Me Idle</span><span class="text-surface-900 dark:text-surface-100">7 days</span></div>
                <div class="flex justify-between"><span>Remember Me Max</span><span class="text-surface-900 dark:text-surface-100">30 days</span></div>
              </div>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-xs uppercase tracking-wider text-amber-600 dark:text-amber-400 mb-2">Token Lifespans</h4>
              <div class="space-y-1.5 text-xs font-mono text-surface-600 dark:text-surface-400">
                <div class="flex justify-between"><span>Access Token</span><span class="text-surface-900 dark:text-surface-100">5 min</span></div>
                <div class="flex justify-between"><span>Implicit Flow Token</span><span class="text-surface-900 dark:text-surface-100">15 min</span></div>
                <div class="flex justify-between"><span>Client Login Timeout</span><span class="text-surface-900 dark:text-surface-100">1 min</span></div>
                <div class="flex justify-between"><span>Login Action Timeout</span><span class="text-surface-900 dark:text-surface-100">5 min</span></div>
              </div>
            </div>
          </div>

          <button onclick="toggleDeepDive('phase6-deep')" class="btn-glow inline-flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: SSO & Token Concepts
          </button>
          <div id="phase6-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-amber-50 dark:bg-surface-800 border border-amber-200 dark:border-amber-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="amber">
              <div>
                <h4 class="font-display font-bold text-amber-700 dark:text-amber-300 mb-1">How SSO Works Across Applications</h4>
                <p>When a user logs in to App A, Keycloak creates a session cookie in the browser. When the user then visits App B, that app redirects to Keycloak, but Keycloak sees the existing session cookie and immediately redirects back with new tokens ‚Äî no login prompt. The user perceives instant access across all connected apps.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-amber-700 dark:text-amber-300 mb-1">Why Short Access Token Lifespans?</h4>
                <p>Access tokens are "bearer tokens" ‚Äî anyone who has one can use it. Short lifespans (5 minutes) limit the damage if a token is leaked. Applications use <strong>refresh tokens</strong> (longer-lived, stored securely server-side) to silently get new access tokens without making the user log in again. This pattern is called "silent renewal."</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-amber-700 dark:text-amber-300 mb-1">Testing the Token</h4>
                <p>Use <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">jwt.io</code> to decode your access token and verify it contains the expected claims: user email, name, realm_access.roles array, department, and any custom attributes. The token header shows the signing algorithm (RS256), and you can validate the signature using Keycloak's public key from its JWKS endpoint.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 7: APP IMPLEMENTATION =============== -->
      <section id="phase7" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-500 text-white text-xs font-bold font-mono">P7</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Application Implementation</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Step 18 ¬∑ Node.js integration example</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">A sample Express.js application showing public routes, protected routes, role-based endpoints, and cell-level data filtering using the Keycloak Node.js adapter.</p>

          <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto mb-4">
            <pre><span class="text-surface-500">// Key endpoints pattern</span>
app.get('/',        <span class="text-amber-400">/* public */</span>);
app.get('/secure',  keycloak.protect(), <span class="text-amber-400">/* any authenticated user */</span>);
app.get('/admin',   keycloak.protect('admin'), <span class="text-amber-400">/* admin role required */</span>);
app.get('/manager', keycloak.protect('manager'), <span class="text-amber-400">/* manager role required */</span>);

<span class="text-surface-500">// Cell-level security: classification + need-to-know check</span>
app.get('/api/docs/:id',
  keycloak.protect(),                          <span class="text-amber-400">// Gate 1: Role</span>
  requireClassifiedAccess('read'),             <span class="text-amber-400">// Gate 2+3: Cls + NTK</span>
  getDocument
);

app.put('/api/docs/:id',
  keycloak.protect('manager'),                 <span class="text-amber-400">// Gate 1: Manager+</span>
  requireClassifiedAccess('update'),           <span class="text-amber-400">// Gate 2+3: Cls + NTK</span>
  updateDocument
);
<span class="text-surface-500">// Executive without NTK = denied</span>
<span class="text-surface-500">// Employee with read-only NTK = can read</span></pre>
          </div>

          <button onclick="toggleDeepDive('phase7-deep')" class="btn-glow inline-flex items-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive: Code Patterns
          </button>
          <div id="phase7-deep" class="deep-dive-content mt-6">
            <div class="deep-dive-panel bg-indigo-50 dark:bg-surface-800 border border-indigo-200 dark:border-indigo-800/60 rounded-xl p-6 pl-7 space-y-4 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="indigo">
              <div>
                <h4 class="font-display font-bold text-indigo-700 dark:text-indigo-300 mb-1">The keycloak-connect Middleware</h4>
                <p>The <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">keycloak-connect</code> package handles the entire OIDC flow for your Express app. <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">keycloak.protect()</code> checks for a valid session/token and redirects to login if missing. <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">keycloak.protect('admin')</code> additionally verifies the user has the specified realm role. The token content is available at <code class="text-xs bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">req.kauth.grant.access_token.content</code>.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-indigo-700 dark:text-indigo-300 mb-1">Layered Security Pattern</h4>
                <p>Good security is layered: (1) the Keycloak middleware verifies authentication, (2) role checks verify authorization at the action level, (3) cell-level checks filter data by department/ownership, (4) PostgreSQL RLS provides database-level enforcement. Even if one layer has a bug, the others still protect your data.</p>
              </div>
              <div>
                <h4 class="font-display font-bold text-indigo-700 dark:text-indigo-300 mb-1">UMA Ticket Authorization</h4>
                <p>For Keycloak's Authorization Services, your app requests a "UMA ticket" from Keycloak's token endpoint, specifying which resource and scope it wants to access. Keycloak evaluates all applicable policies and returns a decision. This moves complex authorization logic out of your application code and into Keycloak's centrally managed policies.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 8: ADVANCED CELL SECURITY =============== -->
      <section id="phase8" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-pink-500 text-white text-xs font-bold font-mono">P8</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Advanced Cell-Level Security</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Step 19 ¬∑ Database-level row security with PostgreSQL</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Implement defense-in-depth by enabling PostgreSQL Row-Level Security. Even if your application code has a flaw, the database enforces access rules automatically based on session variables set from the user‚Äôs JWT token. The RLS policies enforce <strong>both</strong> classification clearance and need-to-know approval at the database layer.</p>

          <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto mb-4">
            <pre><span class="text-surface-500">-- Enable RLS on classified data table</span>
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

<span class="text-surface-500">-- Policy 1: User classification must meet or exceed data classification</span>
CREATE POLICY classification_check ON documents
  FOR ALL
  USING (
    classification_level &lt;= current_setting('app.user_classification', true)::int
  );

<span class="text-surface-500">-- Policy 2: User must have NTK approval for the project code</span>
CREATE POLICY ntk_check ON documents
  FOR SELECT
  USING (
    project_code IS NULL  <span class="text-amber-400">-- unclassified data is visible</span>
    OR EXISTS (
      SELECT 1 FROM user_need_to_know untk
      WHERE untk.user_id = current_setting('app.user_id', true)
        AND untk.project_code = documents.project_code
        AND untk.status = 'approved'
        AND untk.can_read = true
        AND (untk.expires_at IS NULL OR untk.expires_at &gt; NOW())
    )
  );

<span class="text-surface-500">-- In app: set session vars from JWT before any query</span>
await db.query(`SET app.user_id = $1`, [token.sub]);
await db.query(`SET app.user_classification = $1`, [token.classification_level]);
await db.query(`SET app.user_department = $1`, [token.department]);
const results = await db.query('SELECT * FROM documents');
<span class="text-amber-400">-- ‚Üë Filtered by classification + NTK automatically!</span></pre>
          </div>

          <div class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-700/40 rounded-xl p-4 mb-6">
            <h4 class="font-display font-bold text-xs uppercase tracking-wider text-rose-700 dark:text-rose-300 mb-2">üõ°Ô∏è Key Principle: Three-Gate Access Check</h4>
            <div class="grid sm:grid-cols-3 gap-3 text-xs text-surface-600 dark:text-surface-300">
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-rose-100 dark:border-white/10 text-center">
                <div class="text-lg mb-1">üö™</div>
                <strong class="text-rose-700 dark:text-rose-400 block mb-1">Gate 1: Role</strong>
                Does the user‚Äôs role allow this <em>type</em> of action?
              </div>
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-rose-100 dark:border-white/10 text-center">
                <div class="text-lg mb-1">üîí</div>
                <strong class="text-rose-700 dark:text-rose-400 block mb-1">Gate 2: Classification</strong>
                Is the user‚Äôs clearance level ‚â• the data‚Äôs classification?
              </div>
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-rose-100 dark:border-white/10 text-center">
                <div class="text-lg mb-1">üìã</div>
                <strong class="text-rose-700 dark:text-rose-400 block mb-1">Gate 3: Need-to-Know</strong>
                Is the user approved for this project code with the required CRUD action?
              </div>
            </div>
            <p class="text-xs text-rose-700 dark:text-rose-300 mt-3 text-center font-mono">All three gates must pass. Failing <em>any one</em> gate = access denied.</p>
          </div>
        </div>
      </section>

      <!-- =============== PHASE 9: MONITORING =============== -->
      <section id="phase9" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-2">
            <span class="phase-badge inline-flex items-center justify-center w-8 h-8 rounded-lg bg-cyan-500 text-white text-xs font-bold font-mono">P9</span>
            <h2 class="font-display font-800 text-2xl md:text-3xl">Monitoring & Troubleshooting</h2>
          </div>
          <p class="text-sm text-surface-500 dark:text-surface-400 font-mono mb-6">Step 20 ¬∑ Logging, events, and common issues</p>

          <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-6">Enable event logging in both Keycloak and Azure AD to monitor authentication flows, audit access, and diagnose problems.</p>

          <div class="grid sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-2">Keycloak Events</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Realm Settings ‚Üí Events: enable Login Events and Admin Events with 7-day expiration. Monitor successful/failed logins, track IdP usage, and review token issuance.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-2">Azure AD Sign-in Logs</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Azure Portal ‚Üí Azure AD ‚Üí Sign-in logs: monitor authentication requests from Keycloak, review consent grants, and check for errors.</p>
            </div>
          </div>

          <!-- Common Issues -->
          <h3 class="font-display font-bold text-lg mb-4">Common Issues & Fixes</h3>
          <div class="space-y-3 mb-6">
            <details class="group bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 text-sm font-display font-600 flex items-center justify-between">
                Users can't log in via Azure AD
                <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </summary>
              <div class="px-4 pb-4 text-xs text-surface-600 dark:text-surface-400 leading-relaxed">
                Check that the redirect URI matches exactly (no trailing slash differences). Verify the client secret hasn't expired. Confirm Azure AD app permissions are granted admin consent. Enable debug logging: <code class="bg-surface-200 dark:bg-surface-700 px-1 rounded font-mono">./bin/kc.sh start-dev --log-level=DEBUG</code>
              </div>
            </details>
            <details class="group bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 text-sm font-display font-600 flex items-center justify-between">
                Roles not appearing in tokens
                <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </summary>
              <div class="px-4 pb-4 text-xs text-surface-600 dark:text-surface-400 leading-relaxed">
                Verify group claims are configured in Azure AD token configuration. Check Keycloak identity provider mappers are using the correct Azure AD Group Object IDs. Ensure the client scope includes the realm role mapper and is assigned to your client.
              </div>
            </details>
            <details class="group bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 text-sm font-display font-600 flex items-center justify-between">
                Cell-level security not working
                <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </summary>
              <div class="px-4 pb-4 text-xs text-surface-600 dark:text-surface-400 leading-relaxed">
                Verify user attributes are synced from Azure AD (check the user in Keycloak admin). Ensure attribute mappers in client scopes include the attributes in the access token (not just ID token). Review authorization policy JavaScript logic and test in Keycloak's Policy Evaluation tab.
              </div>
            </details>
            <details class="group bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl">
              <summary class="cursor-pointer px-4 py-3 text-sm font-display font-600 flex items-center justify-between">
                SSO session timeout issues
                <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </summary>
              <div class="px-4 pb-4 text-xs text-surface-600 dark:text-surface-400 leading-relaxed">
                Align session timeouts between Azure AD and Keycloak ‚Äî if Azure AD's session expires but Keycloak's hasn't, the user may get unexpected re-login prompts. Check token lifespan configuration and verify the refresh token flow is working correctly in your application.
              </div>
            </details>
          </div>
        </div>
      </section>

      <!-- =============== DEMO SETUP: ENTRA EXTERNAL ID + LOCAL DOCKER =============== -->
      <section id="demo-setup" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-sky-500 to-indigo-600 flex items-center justify-center text-white text-lg">üß™</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Hands-On Demo Setup</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">Personal Azure + local Docker Compose</p>
            </div>
          </div>

          <p class="text-surface-600 dark:text-surface-300 leading-relaxed mb-6">
            This section walks you through building a <strong>fully working demo environment</strong> on your personal Azure account (free tier) and a local Docker Compose stack. You'll use <strong>Microsoft Entra External ID</strong> ‚Äî Microsoft's modern CIAM platform ‚Äî as the upstream identity provider, Keycloak as the broker, a Node.js API, and two demo client apps that prove SSO and RBAC end-to-end.
          </p>

          <!-- What is Entra External ID -->
          <div class="bg-sky-50 dark:bg-sky-900/20 border border-sky-200 dark:border-sky-700/40 rounded-xl p-5 mb-8">
            <h3 class="font-display font-bold text-sky-800 dark:text-sky-300 mb-3 text-lg">What is Microsoft Entra External ID?</h3>
            <p class="text-sm text-surface-700 dark:text-surface-300 leading-relaxed mb-3">
              Entra External ID is Microsoft's next-generation <strong>Customer Identity & Access Management (CIAM)</strong> solution, replacing Azure AD B2C. It creates a separate <em>external tenant</em> ‚Äî isolated from your workforce directory ‚Äî designed specifically for consumer and partner-facing apps.
            </p>
            <div class="grid sm:grid-cols-2 gap-3 mt-4 text-xs">
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-sky-100 dark:border-white/10">
                <span class="font-bold text-sky-700 dark:text-sky-400 block mb-1">Free Tier</span>
                <span class="text-surface-600 dark:text-surface-400">50,000 MAU free. No credit card required for trial. Perfect for development and demos.</span>
              </div>
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-sky-100 dark:border-white/10">
                <span class="font-bold text-sky-700 dark:text-sky-400 block mb-1">External Tenant</span>
                <span class="text-surface-600 dark:text-surface-400">A dedicated directory for customer/partner identities, completely separate from your workforce (Entra ID) tenant.</span>
              </div>
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-sky-100 dark:border-white/10">
                <span class="font-bold text-sky-700 dark:text-sky-400 block mb-1">User Flows</span>
                <span class="text-surface-600 dark:text-surface-400">Built-in sign-up/sign-in flows with customizable branding, MFA, and social provider federation (Google, Facebook, Apple, custom OIDC).</span>
              </div>
              <div class="bg-white/60 dark:bg-surface-800/60 rounded-lg p-3 border border-sky-100 dark:border-white/10">
                <span class="font-bold text-sky-700 dark:text-sky-400 block mb-1">OIDC Standard</span>
                <span class="text-surface-600 dark:text-surface-400">Fully OIDC-compliant. Keycloak can federate with it using the standard discovery endpoint ‚Äî no special SDK needed.</span>
              </div>
            </div>
          </div>

          <!-- Prerequisites -->
          <h3 class="font-display font-bold text-lg mb-3 text-surface-800 dark:text-surface-200">Prerequisites</h3>
          <div class="grid sm:grid-cols-3 gap-3 mb-8 text-sm">
            <div class="flex items-start gap-2 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-3 border border-surface-200 dark:border-surface-700/50">
              <span class="shrink-0 mt-0.5">üîë</span>
              <div><strong class="text-surface-800 dark:text-surface-200">Azure Account</strong><br><span class="text-surface-500 dark:text-surface-400">Free account at azure.microsoft.com. Any personal Microsoft account works.</span></div>
            </div>
            <div class="flex items-start gap-2 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-3 border border-surface-200 dark:border-surface-700/50">
              <span class="shrink-0 mt-0.5">üê≥</span>
              <div><strong class="text-surface-800 dark:text-surface-200">Docker Desktop</strong><br><span class="text-surface-500 dark:text-surface-400">Docker + Docker Compose. WSL2 on Windows or native on macOS/Linux.</span></div>
            </div>
            <div class="flex items-start gap-2 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-3 border border-surface-200 dark:border-surface-700/50">
              <span class="shrink-0 mt-0.5">üíª</span>
              <div><strong class="text-surface-800 dark:text-surface-200">Node.js 18+</strong><br><span class="text-surface-500 dark:text-surface-400">For optional local development. Docker images include Node runtime.</span></div>
            </div>
          </div>

          <!-- PART A: Entra External ID Setup -->
          <div class="mb-10">
            <div class="flex items-center gap-2 mb-4">
              <span class="phase-badge inline-flex items-center gap-1.5 bg-sky-500 text-white text-xs font-bold px-3 py-1 rounded-full font-mono">PART A</span>
              <h3 class="font-display font-bold text-xl text-surface-800 dark:text-surface-200">Entra External ID ‚Äî Azure Portal Setup</h3>
            </div>

            <!-- Step A1 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A1 ‚Äî Create an External Tenant</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-2">
                Sign in to <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">https://entra.microsoft.com</code>. Navigate to <strong>Entra ID ‚Üí Overview ‚Üí Manage tenants ‚Üí + Create</strong>. Select <strong>"External"</strong> and continue. Enter a Tenant Name (e.g., <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">MyDemo Customers</code>) and a unique domain prefix (e.g., <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">mydemocustomers</code>). Click <strong>Review + Create</strong>. Provisioning takes up to 30 minutes.
              </p>
              <div class="bg-amber-50 dark:bg-amber-900/25 border border-amber-200 dark:border-amber-700/40 rounded-lg p-3 text-xs text-amber-800 dark:text-amber-200">
                ‚ö†Ô∏è <strong>Tenant types matter:</strong> A <em>Workforce</em> tenant is for employees (traditional Azure AD). An <em>External</em> tenant is the new Entra External ID ‚Äî it gets self-service sign-up flows and customizable branded sign-in pages. Make sure you select <strong>External</strong>.
              </div>
            </div>

            <!-- Step A2 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A2 ‚Äî Switch to the External Tenant & Run the Guide</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
                Once created, use the <strong>Settings ‚Üí Directories + Subscriptions</strong> menu to switch to your new external tenant. Browse to <strong>Entra ID ‚Üí Overview ‚Üí Get started ‚Üí Start the guide</strong>. The wizard walks you through choosing sign-in methods (Email + password or Email + OTP), adding custom attributes, and branding. Choose <strong>Email and password</strong> for simplicity. Complete a test sign-up with a different email from your admin account.
              </p>
            </div>

            <!-- Step A3 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A3 ‚Äî Register Two App Registrations</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-2">
                Navigate to <strong>App registrations ‚Üí + New registration</strong>. Create two applications:
              </p>
              <div class="grid sm:grid-cols-2 gap-3 text-xs">
                <div class="bg-surface-50 dark:bg-surface-800/60 rounded-lg p-3 border border-surface-200 dark:border-surface-700/50">
                  <strong class="text-sky-700 dark:text-sky-400 block mb-1">1. Keycloak-Broker</strong>
                  <span class="text-surface-600 dark:text-surface-400">
                    Supported account types: <em>"Accounts in this organizational directory only"</em>.<br>
                    Redirect URI (Web): <code class="bg-surface-100 dark:bg-surface-700 px-1 rounded">http://localhost:8080/realms/demo/broker/entra-external/endpoint</code><br>
                    Note the <strong>Application (client) ID</strong> and <strong>Directory (tenant) ID</strong>.
                  </span>
                </div>
                <div class="bg-surface-50 dark:bg-surface-800/60 rounded-lg p-3 border border-surface-200 dark:border-surface-700/50">
                  <strong class="text-sky-700 dark:text-sky-400 block mb-1">2. Demo-SPA-Client</strong>
                  <span class="text-surface-600 dark:text-surface-400">
                    Supported account types: <em>"Accounts in this organizational directory only"</em>.<br>
                    Redirect URI (SPA): <code class="bg-surface-100 dark:bg-surface-700 px-1 rounded">http://localhost:3001/callback</code><br>
                    Enable <strong>Access tokens</strong> and <strong>ID tokens</strong> under Authentication ‚Üí Implicit grant.
                  </span>
                </div>
              </div>
            </div>

            <!-- Step A4 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A4 ‚Äî Create Client Secret for Keycloak-Broker</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
                Open the <strong>Keycloak-Broker</strong> app ‚Üí <strong>Certificates &amp; secrets ‚Üí + New client secret</strong>. Description: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">keycloak-demo-secret</code>, expiry: 6 months. Copy the <strong>Value</strong> immediately ‚Äî you won't see it again. Save it to your <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">.env</code> file.
              </p>
            </div>

            <!-- Step A5 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A5 ‚Äî Configure API Permissions</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
                On the <strong>Keycloak-Broker</strong> app ‚Üí <strong>API permissions ‚Üí + Add a permission ‚Üí Microsoft Graph (Delegated)</strong>. Add: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">openid</code>, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">profile</code>, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">email</code>, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">offline_access</code>. Click <strong>"Grant admin consent"</strong>.
              </p>
            </div>

            <!-- Step A6 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 pb-6 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A6 ‚Äî Create a User Flow</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-2">
                Go to <strong>External Identities ‚Üí User flows ‚Üí + New user flow</strong>. Name: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">demo-signup-signin</code>. Select <strong>Email with password</strong>. Optionally collect Name and City attributes. Click <strong>Create</strong>.
              </p>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
                Then open the flow ‚Üí <strong>Applications ‚Üí + Add application</strong> ‚Üí select both <strong>Keycloak-Broker</strong> and <strong>Demo-SPA-Client</strong>. This binds the sign-in experience to your registered apps.
              </p>
            </div>

            <!-- Step A7 -->
            <div class="ml-2 border-l-2 border-sky-200 dark:border-sky-800 pl-5 relative">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-sky-500 border-2 border-white dark:border-surface-800"></div>
              <h4 class="font-display font-bold text-surface-800 dark:text-surface-200 mb-1">Step A7 ‚Äî Note Your Discovery Endpoint</h4>
              <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-2">
                Your External ID OIDC discovery URL follows this pattern:
              </p>
              <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 text-xs overflow-x-auto">
                <pre>https://<span class="text-sky-400">{your-domain}</span>.ciamlogin.com/<span class="text-sky-400">{tenant-id}</span>/v2.0/.well-known/openid-configuration

<span class="text-surface-500"># Example:</span>
https://mydemocustomers.ciamlogin.com/aaaabbbb-1111-2222-3333-ccccddddeeee/v2.0/.well-known/openid-configuration</pre>
              </div>
              <p class="text-sm text-surface-500 dark:text-surface-400 mt-2">
                This is the URL you'll give Keycloak to auto-discover all token, authorization, and JWKS endpoints.
              </p>
            </div>
          </div>

          <!-- PART B: Docker Compose -->
          <div class="mb-10">
            <div class="flex items-center gap-2 mb-4">
              <span class="phase-badge inline-flex items-center gap-1.5 bg-indigo-500 text-white text-xs font-bold px-3 py-1 rounded-full font-mono">PART B</span>
              <h3 class="font-display font-bold text-xl text-surface-800 dark:text-surface-200">Local Docker Compose Stack</h3>
            </div>

            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">
              Create the following files in a project directory. The stack runs <strong>Keycloak</strong> (identity broker), a <strong>Node.js Express API</strong> (resource server), and two <strong>demo client apps</strong> (SPA frontends), plus PostgreSQL for Keycloak storage.
            </p>

            <!-- .env file -->
            <h4 class="font-display font-bold text-sm text-surface-800 dark:text-surface-200 mb-2 flex items-center gap-2"><span class="text-indigo-500">‚ë†</span> .env</h4>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-5 text-xs overflow-x-auto">
              <pre><span class="text-surface-500"># === Entra External ID (from Azure Portal) ===</span>
<span class="text-emerald-400">ENTRA_TENANT_ID</span>=aaaabbbb-1111-2222-3333-ccccddddeeee
<span class="text-emerald-400">ENTRA_CLIENT_ID</span>=11112222-aaaa-bbbb-cccc-333344445555
<span class="text-emerald-400">ENTRA_CLIENT_SECRET</span>=your-client-secret-value-here
<span class="text-emerald-400">ENTRA_DOMAIN</span>=mydemocustomers

<span class="text-surface-500"># === Keycloak ===</span>
<span class="text-emerald-400">KC_DB_PASSWORD</span>=supersecretdb
<span class="text-emerald-400">KC_ADMIN</span>=admin
<span class="text-emerald-400">KC_ADMIN_PASSWORD</span>=admin123!</pre>
            </div>

            <!-- docker-compose.yml -->
            <h4 class="font-display font-bold text-sm text-surface-800 dark:text-surface-200 mb-2 flex items-center gap-2"><span class="text-indigo-500">‚ë°</span> docker-compose.yml</h4>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-5 text-xs overflow-x-auto">
              <pre><span class="text-sky-400">version</span>: "3.9"
<span class="text-sky-400">services</span>:

  <span class="text-amber-400">postgres</span>:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KC_DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      retries: 5

  <span class="text-amber-400">keycloak</span>:
    image: quay.io/keycloak/keycloak:25.0
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
      KC_HEALTH_ENABLED: "true"
      KEYCLOAK_ADMIN: ${KC_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KC_ADMIN_PASSWORD}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy

  <span class="text-amber-400">api</span>:
    build: ./api
    ports:
      - "4000:4000"
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: demo
      PORT: 4000
    depends_on:
      - keycloak

  <span class="text-amber-400">client-a</span>:
    build: ./client
    ports:
      - "3001:80"
    environment:
      VITE_KC_URL: http://localhost:8080
      VITE_KC_REALM: demo
      VITE_KC_CLIENT: client-a
      VITE_API_URL: http://localhost:4000

  <span class="text-amber-400">client-b</span>:
    build: ./client
    ports:
      - "3002:80"
    environment:
      VITE_KC_URL: http://localhost:8080
      VITE_KC_REALM: demo
      VITE_KC_CLIENT: client-b
      VITE_API_URL: http://localhost:4000

<span class="text-sky-400">volumes</span>:
  pgdata:</pre>
            </div>

            <!-- API Dockerfile -->
            <h4 class="font-display font-bold text-sm text-surface-800 dark:text-surface-200 mb-2 flex items-center gap-2"><span class="text-indigo-500">‚ë¢</span> api/Dockerfile + server.js</h4>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-3 text-xs overflow-x-auto">
              <pre><span class="text-surface-500"># api/Dockerfile</span>
FROM node:20-alpine
WORKDIR /app
COPY package.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["node", "server.js"]</pre>
            </div>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-5 text-xs overflow-x-auto">
              <pre><span class="text-surface-500">// api/server.js ‚Äî Resource server with JWT validation</span>
<span class="text-violet-400">const</span> express = require(<span class="text-emerald-400">"express"</span>);
<span class="text-violet-400">const</span> jwt = require(<span class="text-emerald-400">"jsonwebtoken"</span>);
<span class="text-violet-400">const</span> jwksClient = require(<span class="text-emerald-400">"jwks-rsa"</span>);
<span class="text-violet-400">const</span> cors = require(<span class="text-emerald-400">"cors"</span>);

<span class="text-violet-400">const</span> app = express();
app.use(cors());

<span class="text-violet-400">const</span> client = jwksClient({
  jwksUri: `${process.env.KEYCLOAK_URL}/realms/${process.env.KEYCLOAK_REALM}/protocol/openid-connect/certs`
});

<span class="text-violet-400">function</span> <span class="text-amber-400">getKey</span>(header, cb) {
  client.getSigningKey(header.kid, (err, key) =&gt; {
    cb(err, key?.publicKey || key?.rsaPublicKey);
  });
}

<span class="text-violet-400">function</span> <span class="text-amber-400">protect</span>(...roles) {
  <span class="text-violet-400">return</span> (req, res, next) =&gt; {
    <span class="text-violet-400">const</span> token = req.headers.authorization?.split(<span class="text-emerald-400">" "</span>)[1];
    <span class="text-violet-400">if</span> (!token) <span class="text-violet-400">return</span> res.status(401).json({ error: <span class="text-emerald-400">"No token"</span> });
    jwt.verify(token, getKey, (err, decoded) =&gt; {
      <span class="text-violet-400">if</span> (err) <span class="text-violet-400">return</span> res.status(403).json({ error: <span class="text-emerald-400">"Invalid token"</span> });
      <span class="text-violet-400">if</span> (roles.length &gt; 0) {
        <span class="text-violet-400">const</span> userRoles = decoded.realm_access?.roles || [];
        <span class="text-violet-400">if</span> (!roles.some(r =&gt; userRoles.includes(r)))
          <span class="text-violet-400">return</span> res.status(403).json({ error: <span class="text-emerald-400">"Insufficient role"</span> });
      }
      req.user = decoded;
      next();
    });
  };
}

app.get(<span class="text-emerald-400">"/api/public"</span>, (req, res) =&gt;
  res.json({ message: <span class="text-emerald-400">"Public ‚Äî no auth needed"</span> }));

app.get(<span class="text-emerald-400">"/api/profile"</span>, protect(), (req, res) =&gt;
  res.json({ user: req.user.preferred_username,
             email: req.user.email,
             roles: req.user.realm_access?.roles }));

app.get(<span class="text-emerald-400">"/api/admin"</span>, protect(<span class="text-emerald-400">"admin"</span>), (req, res) =&gt;
  res.json({ message: <span class="text-emerald-400">"Admin-only data"</span>, user: req.user.preferred_username }));

app.listen(4000, () =&gt; console.log(<span class="text-emerald-400">"API on :4000"</span>));</pre>
            </div>

            <!-- Client -->
            <h4 class="font-display font-bold text-sm text-surface-800 dark:text-surface-200 mb-2 flex items-center gap-2"><span class="text-indigo-500">‚ë£</span> client/ ‚Äî Demo SPA (keycloak-js)</h4>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-5 text-xs overflow-x-auto">
              <pre><span class="text-surface-500">&lt;!-- client/index.html ‚Äî Minimal SPA that proves SSO --&gt;</span>
<span class="text-sky-400">&lt;script</span> src=<span class="text-emerald-400">"https://cdn.jsdelivr.net/npm/keycloak-js@25/dist/keycloak.min.js"</span><span class="text-sky-400">&gt;&lt;/script&gt;</span>
<span class="text-sky-400">&lt;script&gt;</span>
  <span class="text-violet-400">const</span> kc = <span class="text-violet-400">new</span> Keycloak({
    url:      <span class="text-emerald-400">"http://localhost:8080"</span>,
    realm:    <span class="text-emerald-400">"demo"</span>,
    clientId: <span class="text-emerald-400">"client-a"</span>  <span class="text-surface-500">// or "client-b" for second app</span>
  });

  kc.init({ onLoad: <span class="text-emerald-400">"login-required"</span>, pkceMethod: <span class="text-emerald-400">"S256"</span> })
    .then(auth =&gt; {
      <span class="text-violet-400">if</span> (!auth) window.location.reload();
      document.getElementById(<span class="text-emerald-400">"user"</span>).textContent = kc.tokenParsed.preferred_username;
      document.getElementById(<span class="text-emerald-400">"roles"</span>).textContent =
        JSON.stringify(kc.tokenParsed.realm_access?.roles);

      <span class="text-surface-500">// Call protected API</span>
      fetch(<span class="text-emerald-400">"http://localhost:4000/api/profile"</span>, {
        headers: { Authorization: <span class="text-emerald-400">`Bearer ${kc.token}`</span> }
      }).then(r =&gt; r.json()).then(d =&gt; {
        document.getElementById(<span class="text-emerald-400">"api"</span>).textContent = JSON.stringify(d, null, 2);
      });
    });
<span class="text-sky-400">&lt;/script&gt;</span>
<span class="text-sky-400">&lt;h1&gt;</span>Demo Client<span class="text-sky-400">&lt;/h1&gt;</span>
<span class="text-sky-400">&lt;p&gt;</span>User: <span class="text-sky-400">&lt;b</span> id=<span class="text-emerald-400">"user"</span><span class="text-sky-400">&gt;&lt;/b&gt;&lt;/p&gt;</span>
<span class="text-sky-400">&lt;p&gt;</span>Roles: <span class="text-sky-400">&lt;code</span> id=<span class="text-emerald-400">"roles"</span><span class="text-sky-400">&gt;&lt;/code&gt;&lt;/p&gt;</span>
<span class="text-sky-400">&lt;pre</span> id=<span class="text-emerald-400">"api"</span><span class="text-sky-400">&gt;&lt;/pre&gt;</span></pre>
            </div>

            <h4 class="font-display font-bold text-sm text-surface-800 dark:text-surface-200 mb-2 flex items-center gap-2"><span class="text-indigo-500">‚ë§</span> Launch the Stack</h4>
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-surface-100 rounded-lg p-4 mb-5 text-xs overflow-x-auto">
              <pre><span class="text-surface-500"># Start everything</span>
docker compose up -d --build

<span class="text-surface-500"># Wait for Keycloak health check</span>
docker compose logs -f keycloak | grep <span class="text-emerald-400">"Listening on"</span>

<span class="text-surface-500"># Endpoints:</span>
<span class="text-sky-400">Keycloak Admin</span>  ‚Üí http://localhost:8080  (admin / admin123!)
<span class="text-sky-400">Demo Client A</span>   ‚Üí http://localhost:3001
<span class="text-sky-400">Demo Client B</span>   ‚Üí http://localhost:3002
<span class="text-sky-400">API</span>             ‚Üí http://localhost:4000/api/public</pre>
            </div>
          </div>

          <!-- PART C: Keycloak Configuration -->
          <div class="mb-10">
            <div class="flex items-center gap-2 mb-4">
              <span class="phase-badge inline-flex items-center gap-1.5 bg-brand-500 text-white text-xs font-bold px-3 py-1 rounded-full font-mono">PART C</span>
              <h3 class="font-display font-bold text-xl text-surface-800 dark:text-surface-200">Keycloak ‚Äî Wire Up Federation</h3>
            </div>

            <div class="space-y-4 text-sm text-surface-600 dark:text-surface-300 leading-relaxed">
              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">1</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Create Realm "demo"</strong> ‚Äî Log into Keycloak admin console. Click the realm dropdown ‚Üí Create Realm ‚Üí Name: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">demo</code>. Enable it.</div>
              </div>

              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">2</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Add Entra External ID as Identity Provider</strong> ‚Äî Go to <strong>Identity Providers ‚Üí Add provider ‚Üí OpenID Connect v1.0</strong>. Set Alias: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">entra-external</code>. Paste the OIDC discovery URL from Step A7. Enter the Client ID and Secret from Step A3/A4. Set <strong>Client Authentication: Client secret sent as post</strong>. Set Default Scopes: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">openid profile email</code>.</div>
              </div>

              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">3</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Add Attribute Mappers</strong> ‚Äî Under the IdP ‚Üí Mappers tab, add: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">email</code> ‚Üí email, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">given_name</code> ‚Üí firstName, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">family_name</code> ‚Üí lastName. Set Sync Mode: <strong>FORCE</strong> so attributes update on every login.</div>
              </div>

              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">4</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Create Clients in Keycloak</strong> ‚Äî Create two OIDC clients: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">client-a</code> (Root URL: <code class="text-xs">http://localhost:3001</code>) and <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">client-b</code> (Root URL: <code class="text-xs">http://localhost:3002</code>). Both: Access Type = <strong>public</strong>, Standard Flow = ON, Valid Redirect URIs = <code class="text-xs">http://localhost:3001/*</code> (or 3002). Web Origins = <code class="text-xs">+</code>.</div>
              </div>

              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">5</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Create Roles & Client Scope</strong> ‚Äî Create realm roles: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">employee</code>, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">manager</code>, <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">admin</code>. Create a client scope "roles" with a <strong>User Realm Role</strong> mapper to embed roles in the access token. Assign default role to <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1.5 py-0.5 rounded">employee</code>.</div>
              </div>

              <div class="flex items-start gap-3 bg-surface-50 dark:bg-surface-800/60 rounded-lg p-4 border border-surface-200 dark:border-surface-700/50">
                <span class="shrink-0 bg-brand-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center">6</span>
                <div><strong class="text-surface-800 dark:text-surface-200">Test the Full Flow</strong> ‚Äî Open <code class="text-xs">http://localhost:3001</code>. Keycloak login page appears with a "Sign in with Entra External ID" button. Click it ‚Üí you're redirected to the Entra External ID branded sign-in page ‚Üí log in with your test user ‚Üí redirected back to Keycloak ‚Üí then back to Client A with a valid JWT. Open <code class="text-xs">http://localhost:3002</code> in another tab ‚Äî you should be logged in automatically via SSO (no password prompt).</div>
              </div>
            </div>
          </div>

          <!-- Deep Dive: How It All Works -->
          <button onclick="toggleDeepDive('demo-deep')" class="btn-glow inline-flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300 mb-4">
            <svg class="w-4 h-4 transition-transform duration-300" id="demo-deep-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            Deep Dive ‚Äî How Entra External ID Federation Works
          </button>
          <div id="demo-deep" class="deep-dive-content mt-2">
            <div class="deep-dive-panel bg-sky-50 dark:bg-surface-800 border border-sky-200 dark:border-sky-800/60 rounded-xl p-6 pl-7 space-y-5 text-sm text-surface-700 dark:text-surface-300 leading-relaxed" data-accent="blue">
              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">Workforce Tenant vs. External Tenant</h4>
              <p>
                Traditional Azure AD (now "Entra ID") creates a <strong>workforce tenant</strong> ‚Äî a directory for your employees. <strong>Entra External ID</strong> creates an <strong>external tenant</strong>, a completely separate directory purpose-built for consumers, partners, and external users. The external tenant has its own set of features: customizable sign-up pages, self-service password reset, social login federation (Google, Facebook, Apple), custom OIDC providers, and user-flow-based policies. Think of it as Azure AD B2C's successor ‚Äî simpler, more integrated, and built into the Entra admin center.
              </p>

              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">The OIDC Discovery Endpoint</h4>
              <p>
                External tenants use a special domain: <code>*.ciamlogin.com</code> (Customer IAM Login). The discovery URL returns a JSON document containing the authorization endpoint, token endpoint, JWKS URI, supported scopes, and claims. When you paste this into Keycloak, it auto-populates all the OIDC configuration fields ‚Äî no manual endpoint entry needed.
              </p>
              <div class="inner-block bg-white/60 dark:bg-surface-900/60 rounded-lg p-3 border border-transparent dark:border-white/5 text-xs font-mono">
                <pre>{
  "issuer": "https://mydemocustomers.ciamlogin.com/{tid}/v2.0",
  "authorization_endpoint": ".../{tid}/oauth2/v2.0/authorize",
  "token_endpoint": ".../{tid}/oauth2/v2.0/token",
  "jwks_uri": ".../{tid}/discovery/v2.0/keys",
  "scopes_supported": ["openid", "profile", "email", "offline_access"],
  "response_types_supported": ["code", "id_token", "code id_token"]
}</pre>
              </div>

              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">User Flows vs. Custom Auth Policies</h4>
              <p>
                <strong>User Flows</strong> are the declarative, no-code way to define sign-up/sign-in experiences. You select the sign-in method (email+password, email+OTP), choose which attributes to collect, and bind the flow to specific app registrations. Under the hood, a user flow creates an Authorization endpoint that triggers the correct authentication experience. For more complex scenarios, you can use <strong>Custom Authentication Extensions</strong> (REST API callbacks during the flow) ‚Äî but user flows cover most demo and production cases.
              </p>

              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">How the Demo Authentication Flow Works</h4>
              <div class="space-y-2">
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">1.</span><span>User visits <code>localhost:3001</code>. The <code>keycloak-js</code> adapter detects no session and redirects to <code>Keycloak /auth</code>.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">2.</span><span>Keycloak's login page shows "Sign in with Entra External ID". User clicks it.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">3.</span><span>Keycloak builds an OIDC Authorization Code request to the Entra External ID <code>authorize</code> endpoint, including its client ID, redirect URI (the broker endpoint), and scopes.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">4.</span><span>Entra External ID presents the branded sign-in page. The user enters their email and password (or uses OTP). Entra runs the user flow policy (validates credentials, collects attributes, applies MFA if configured).</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">5.</span><span>Entra issues an <strong>authorization code</strong> and redirects back to Keycloak's broker endpoint with the code.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">6.</span><span>Keycloak exchanges the code for <strong>ID token + access token</strong> by calling Entra's token endpoint (server-to-server, with client secret). The ID token contains claims like <code>email</code>, <code>given_name</code>, <code>family_name</code>, <code>sub</code>.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">7.</span><span>Keycloak's <strong>attribute mappers</strong> extract claims and populate the Keycloak user profile. If it's first login, the <strong>First Broker Login</strong> flow creates a new local user (or links to an existing one).</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">8.</span><span>Keycloak creates its own <strong>SSO session</strong> and issues its own JWT (access token + refresh token) containing Keycloak realm roles and custom claims. The Entra tokens are consumed internally ‚Äî your apps never see them.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">9.</span><span>Keycloak redirects back to <code>localhost:3001</code> with the auth code. <code>keycloak-js</code> exchanges it for the Keycloak JWT. The SPA calls the API with <code>Authorization: Bearer {kc-token}</code>.</span></div>
                <div class="flex items-start gap-2"><span class="shrink-0 text-sky-500 font-bold">10.</span><span>When the user opens <code>localhost:3002</code> (Client B), <code>keycloak-js</code> redirects to Keycloak, which sees the existing SSO cookie and immediately issues new tokens ‚Äî <strong>zero login prompts</strong>. That's SSO in action.</span></div>
              </div>

              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">Why Broker Through Keycloak Instead of Directly Using Entra?</h4>
              <p>
                You could point your apps directly at Entra External ID ‚Äî it supports OIDC natively. But brokering through Keycloak gives you: <strong>role management</strong> (Entra External ID doesn't have Keycloak-style realm roles or composite roles), <strong>multi-IdP support</strong> (add Google, SAML, LDAP alongside Entra without changing app code), <strong>protocol translation</strong> (serve SAML apps behind OIDC IdPs), <strong>fine-grained authorization</strong> (Keycloak Authorization Services, UMA), and <strong>portability</strong> ‚Äî if you ever switch from Entra to Okta or another IdP, only the Keycloak broker config changes; your apps are untouched.
              </p>

              <h4 class="font-display font-bold text-sky-700 dark:text-sky-300 text-base mb-2">Pricing & Limits</h4>
              <p>
                Entra External ID is free for the first <strong>50,000 monthly active users (MAU)</strong>. An MAU is a unique user who authenticates at least once in a calendar month. Beyond that, pricing is per-MAU. For development and small-scale demos, the free tier is more than sufficient. The 30-day free trial includes all features; after that, link an Azure subscription to continue.
              </p>
            </div>
          </div>

        </div>
      </section>

      <!-- =============== ACCESS CONTROL MATRIX =============== -->
      <section id="access-matrix" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-brand-600 flex items-center justify-center text-white text-lg">üìä</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Access Control Matrix</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">Who can do what</p>
            </div>
          </div>

          <!-- Role Capability Matrix -->
          <h3 class="font-display font-bold text-lg mb-3">Role Capability Matrix <span class="text-xs font-mono text-surface-400 dark:text-surface-500">(what the role <em>permits</em>)</span></h3>
          <div class="overflow-x-auto -mx-2 mb-8">
            <table class="access-matrix w-full text-xs border-collapse">
              <thead>
                <tr class="bg-surface-100 dark:bg-surface-900/60">
                  <th class="text-left px-3 py-2.5 font-display font-bold text-surface-700 dark:text-surface-200 rounded-tl-lg">Role</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Create</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Read Own</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Public</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Team</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Dept</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">All</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Edit Own</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Edit Team</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Delete</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Share</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400 rounded-tr-lg">Audit</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-surface-100 dark:divide-surface-700/30">
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Employee</td>
                  <td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚ùå</td><td>‚ùå</td><td>‚ùå</td><td>‚úÖ</td><td>‚ùå</td><td>‚úÖ</td><td>‚ùå</td><td>‚ùå</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Manager</td>
                  <td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚ùå</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Director</td>
                  <td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Executive</td>
                  <td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td><td>‚úÖ</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Classification & Need-to-Know Gate -->
          <h3 class="font-display font-bold text-lg mb-3">Classification & Need-to-Know Gate <span class="text-xs font-mono text-rose-500">(overrides role)</span></h3>
          <div class="bg-rose-50 dark:bg-rose-900/15 border border-rose-200 dark:border-rose-700/40 rounded-xl p-5 mb-6">
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-4">Even if the role matrix above shows ‚úÖ for an action, the user is <strong>blocked</strong> unless they also pass both classification and need-to-know checks for the specific data item. CRUD permissions are granted <strong>individually per NTK approval</strong>.</p>
            <div class="overflow-x-auto -mx-2">
              <table class="access-matrix w-full text-xs border-collapse">
                <thead>
                  <tr class="bg-rose-100 dark:bg-rose-900/40">
                    <th class="text-left px-3 py-2.5 font-display font-bold text-rose-800 dark:text-rose-200 rounded-tl-lg">Data Classification</th>
                    <th class="font-mono text-rose-600 dark:text-rose-300">Min. Clearance</th>
                    <th class="font-mono text-rose-600 dark:text-rose-300">NTK Required?</th>
                    <th class="font-mono text-rose-600 dark:text-rose-300">NTK CRUD Scoped?</th>
                    <th class="font-mono text-rose-600 dark:text-rose-300 rounded-tr-lg">Example</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-rose-100 dark:divide-rose-800/30">
                  <tr class="hover:bg-rose-50/50 dark:hover:bg-rose-900/20 transition">
                    <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">L0 ‚Äî Public</td>
                    <td>None</td><td>‚ùå No</td><td>‚Äî</td><td class="text-left text-surface-500 dark:text-surface-400">Company blog posts</td>
                  </tr>
                  <tr class="hover:bg-rose-50/50 dark:hover:bg-rose-900/20 transition">
                    <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">L1 ‚Äî Internal</td>
                    <td>L1+</td><td>‚ùå No</td><td>‚Äî</td><td class="text-left text-surface-500 dark:text-surface-400">Team wikis, org charts</td>
                  </tr>
                  <tr class="hover:bg-rose-50/50 dark:hover:bg-rose-900/20 transition">
                    <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">L2 ‚Äî Confidential</td>
                    <td>L2+</td><td>‚úÖ Yes</td><td>‚úÖ Yes</td><td class="text-left text-surface-500 dark:text-surface-400">Financial forecasts, HR reports</td>
                  </tr>
                  <tr class="hover:bg-rose-50/50 dark:hover:bg-rose-900/20 transition">
                    <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">L3 ‚Äî Restricted</td>
                    <td>L3+</td><td>‚úÖ Yes</td><td>‚úÖ Yes</td><td class="text-left text-surface-500 dark:text-surface-400">M&A plans, security audits</td>
                  </tr>
                  <tr class="hover:bg-rose-50/50 dark:hover:bg-rose-900/20 transition">
                    <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">L4 ‚Äî Top-Secret</td>
                    <td>L4</td><td>‚úÖ Yes</td><td>‚úÖ Yes</td><td class="text-left text-surface-500 dark:text-surface-400">Board strategies, legal matters</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Real-World Scenario Table -->
          <h3 class="font-display font-bold text-lg mb-3">Real-World Scenario: Who Gets Access?</h3>
          <div class="overflow-x-auto -mx-2 mb-4">
            <table class="access-matrix w-full text-xs border-collapse">
              <thead>
                <tr class="bg-surface-100 dark:bg-surface-900/60">
                  <th class="text-left px-3 py-2.5 font-display font-bold text-surface-700 dark:text-surface-200 rounded-tl-lg">User</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Role</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">Clearance</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">NTK: ATLAS</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400">L3 Doc in ATLAS</th>
                  <th class="font-mono text-surface-500 dark:text-surface-400 rounded-tr-lg">Allowed CRUD</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-surface-100 dark:divide-surface-700/30">
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Alice</td>
                  <td>Executive</td><td>L4</td><td class="text-rose-500 font-bold">‚ùå None</td><td class="text-rose-500 font-bold">‚ùå DENIED</td><td>‚Äî</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Bob</td>
                  <td>Employee</td><td>L3</td><td class="text-emerald-500 font-bold">‚úÖ R</td><td class="text-emerald-500 font-bold">‚úÖ Read</td><td>Read only</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Carol</td>
                  <td>Manager</td><td>L2</td><td class="text-emerald-500 font-bold">‚úÖ CRUD</td><td class="text-rose-500 font-bold">‚ùå DENIED</td><td>Clearance L2 &lt; L3</td>
                </tr>
                <tr class="hover:bg-surface-50 dark:hover:bg-surface-800/40 transition">
                  <td class="text-left px-3 font-display font-600 text-surface-700 dark:text-surface-200">Dave</td>
                  <td>Director</td><td>L3</td><td class="text-emerald-500 font-bold">‚úÖ CR</td><td class="text-emerald-500 font-bold">‚úÖ Create+Read</td><td>Create, Read only</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="text-xs text-surface-400 dark:text-surface-500 mt-3">‚ö†Ô∏è Role capability + Classification clearance + Need-to-Know approval with CRUD scope ‚Äî all three must align for access.</p>
        </div>
      </section>

      <!-- =============== CLASSIFICATION & NEED-TO-KNOW =============== -->
      <section id="classification-ntk" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-500 to-orange-600 flex items-center justify-center text-white text-lg">üè∑Ô∏è</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Classification & Need-to-Know</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">Cell-level security independent of role hierarchy</p>
            </div>
          </div>

          <p class="text-surface-600 dark:text-surface-300 leading-relaxed mb-6">
            Traditional RBAC answers <em>"what actions can this role perform?"</em> but it does not answer <em>"should this specific user see this specific piece of data?"</em> The Classification & Need-to-Know model adds two independent security dimensions that <strong>override</strong> role permissions. A user must satisfy <strong>all three gates</strong> ‚Äî role, classification, and need-to-know ‚Äî to access any classified data.
          </p>

          <!-- Core Concept Cards -->
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <div class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-700/40 rounded-xl p-4">
              <div class="text-rose-500 text-lg mb-2">üîí</div>
              <h4 class="font-display font-bold text-sm mb-1">Classification Level</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Every data record is tagged with a level: <strong>L0</strong> (Public), <strong>L1</strong> (Internal), <strong>L2</strong> (Confidential), <strong>L3</strong> (Restricted), <strong>L4</strong> (Top-Secret). Every user is granted a <strong>clearance level</strong> by a security officer. User clearance must ‚â• data level.</p>
            </div>
            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/40 rounded-xl p-4">
              <div class="text-orange-500 text-lg mb-2">üìã</div>
              <h4 class="font-display font-bold text-sm mb-1">Need-to-Know (NTK)</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Data at L2+ is grouped under a <strong>project code</strong> (e.g., PROJECT-ATLAS). A user must have an <strong>approved NTK entry</strong> for that project ‚Äî granted by the project owner or a security officer ‚Äî regardless of their role or clearance level.</p>
            </div>
            <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/40 rounded-xl p-4">
              <div class="text-amber-500 text-lg mb-2">‚úÇÔ∏è</div>
              <h4 class="font-display font-bold text-sm mb-1">CRUD-Scoped Permissions</h4>
              <p class="text-xs text-surface-600 dark:text-surface-300 leading-relaxed">Each NTK approval specifies <strong>exactly</strong> which operations the user may perform: <code class="font-mono text-[0.65rem]">can_create</code>, <code class="font-mono text-[0.65rem]">can_read</code>, <code class="font-mono text-[0.65rem]">can_update</code>, <code class="font-mono text-[0.65rem]">can_delete</code>. An analyst might get Read-only; a project lead might get full CRUD.</p>
            </div>
          </div>

          <!-- The Three-Gate Model Visualization -->
          <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-6 mb-8">
            <h3 class="font-display font-bold text-lg mb-4 text-center">The Three-Gate Access Model</h3>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-2 text-xs font-mono">
              <div class="bg-emerald-100 dark:bg-emerald-900/30 border-2 border-emerald-400 dark:border-emerald-600 rounded-xl px-4 py-3 text-center min-w-[140px]">
                <div class="text-emerald-600 dark:text-emerald-400 font-bold mb-1">GATE 1</div>
                <div class="text-surface-700 dark:text-surface-300 font-display font-600">Role Check</div>
                <div class="text-surface-500 text-[0.65rem] mt-1">Can this role perform<br>this type of action?</div>
              </div>
              <svg class="w-6 h-6 text-surface-400 shrink-0 rotate-90 sm:rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
              <div class="bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-400 dark:border-rose-600 rounded-xl px-4 py-3 text-center min-w-[140px]">
                <div class="text-rose-600 dark:text-rose-400 font-bold mb-1">GATE 2</div>
                <div class="text-surface-700 dark:text-surface-300 font-display font-600">Classification</div>
                <div class="text-surface-500 text-[0.65rem] mt-1">User clearance ‚â•<br>data classification?</div>
              </div>
              <svg class="w-6 h-6 text-surface-400 shrink-0 rotate-90 sm:rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
              <div class="bg-orange-100 dark:bg-orange-900/30 border-2 border-orange-400 dark:border-orange-600 rounded-xl px-4 py-3 text-center min-w-[140px]">
                <div class="text-orange-600 dark:text-orange-400 font-bold mb-1">GATE 3</div>
                <div class="text-surface-700 dark:text-surface-300 font-display font-600">Need-to-Know</div>
                <div class="text-surface-500 text-[0.65rem] mt-1">Approved NTK for<br>this project + CRUD?</div>
              </div>
              <svg class="w-6 h-6 text-surface-400 shrink-0 rotate-90 sm:rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
              <div class="bg-brand-100 dark:bg-brand-900/30 border-2 border-brand-500 rounded-xl px-4 py-3 text-center min-w-[140px]">
                <div class="text-brand-600 dark:text-brand-400 font-bold mb-1">‚úÖ ACCESS</div>
                <div class="text-surface-700 dark:text-surface-300 font-display font-600">Granted</div>
                <div class="text-surface-500 text-[0.65rem] mt-1">Only the CRUD actions<br>approved in NTK</div>
              </div>
            </div>
            <p class="text-xs text-surface-400 dark:text-surface-500 text-center mt-3 font-mono">Any gate failure = ‚ùå Access Denied (regardless of other gates passing)</p>
          </div>

          <!-- NTK Approval Workflow -->
          <h3 class="font-display font-bold text-lg mb-3">NTK Approval Workflow</h3>
          <div class="space-y-3 mb-8">
            <div class="flex gap-3"><span class="shrink-0 w-7 h-7 rounded-full bg-rose-500 text-white text-xs flex items-center justify-center font-bold">1</span><div class="text-sm text-surface-600 dark:text-surface-300"><strong>Request:</strong> User submits NTK request specifying the project code, a justification, and which CRUD actions they need.</div></div>
            <div class="flex gap-3"><span class="shrink-0 w-7 h-7 rounded-full bg-rose-500 text-white text-xs flex items-center justify-center font-bold">2</span><div class="text-sm text-surface-600 dark:text-surface-300"><strong>Review:</strong> The project owner or security officer reviews the request, verifies the user‚Äôs clearance level, and evaluates the justification.</div></div>
            <div class="flex gap-3"><span class="shrink-0 w-7 h-7 rounded-full bg-rose-500 text-white text-xs flex items-center justify-center font-bold">3</span><div class="text-sm text-surface-600 dark:text-surface-300"><strong>Approve with CRUD scope:</strong> The approver grants only the minimum operations needed. For example: <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1 rounded">can_read = true</code>, all others false.</div></div>
            <div class="flex gap-3"><span class="shrink-0 w-7 h-7 rounded-full bg-rose-500 text-white text-xs flex items-center justify-center font-bold">4</span><div class="text-sm text-surface-600 dark:text-surface-300"><strong>Expiration:</strong> NTK approvals can have an <code class="font-mono text-xs bg-surface-100 dark:bg-surface-700 px-1 rounded">expires_at</code> date. Expired approvals are automatically denied. Regular review cycles ensure access doesn‚Äôt persist beyond need.</div></div>
            <div class="flex gap-3"><span class="shrink-0 w-7 h-7 rounded-full bg-rose-500 text-white text-xs flex items-center justify-center font-bold">5</span><div class="text-sm text-surface-600 dark:text-surface-300"><strong>Audit:</strong> Every access attempt is logged with classification check result, NTK check result, and whether access was ultimately granted or denied.</div></div>
          </div>

          <!-- Middleware Code Example -->
          <h3 class="font-display font-bold text-lg mb-3">Implementation: Express.js Middleware</h3>
          <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto mb-6">
            <pre><span class="text-surface-500">// Three-gate access check middleware</span>
<span class="text-violet-400">function</span> <span class="text-amber-400">requireClassifiedAccess</span>(crudAction) {
  <span class="text-violet-400">return</span> <span class="text-violet-400">async</span> (req, res, next) =&gt; {
    <span class="text-violet-400">const</span> token = req.user; <span class="text-surface-500">// from JWT middleware</span>
    <span class="text-violet-400">const</span> docId = req.params.id;

    <span class="text-surface-500">// Fetch the document's classification &amp; project code</span>
    <span class="text-violet-400">const</span> doc = <span class="text-violet-400">await</span> db.query(
      <span class="text-emerald-400">'SELECT classification_level, project_code FROM documents WHERE id = $1'</span>,
      [docId]
    );

    <span class="text-surface-500">// Gate 1: Role check (already handled by keycloak.protect())</span>

    <span class="text-surface-500">// Gate 2: Classification check</span>
    <span class="text-violet-400">const</span> userLevel = token.classification_level || 0;
    <span class="text-violet-400">if</span> (userLevel &lt; doc.classification_level) {
      <span class="text-violet-400">await</span> auditLog(docId, token, <span class="text-emerald-400">'DENIED'</span>, <span class="text-emerald-400">'Classification insufficient'</span>);
      <span class="text-violet-400">return</span> res.status(403).json({ error: <span class="text-emerald-400">'Classification level insufficient'</span> });
    }

    <span class="text-surface-500">// Gate 3: Need-to-Know check (for L2+ data with a project code)</span>
    <span class="text-violet-400">if</span> (doc.project_code &amp;&amp; doc.classification_level &gt;= 2) {
      <span class="text-violet-400">const</span> ntk = <span class="text-violet-400">await</span> db.query(
        <span class="text-emerald-400">`SELECT * FROM user_need_to_know
         WHERE user_id = $1 AND project_code = $2
           AND status = 'approved'
           AND (expires_at IS NULL OR expires_at &gt; NOW())`</span>,
        [token.sub, doc.project_code]
      );

      <span class="text-violet-400">if</span> (!ntk.rows.length) {
        <span class="text-violet-400">await</span> auditLog(docId, token, <span class="text-emerald-400">'DENIED'</span>, <span class="text-emerald-400">'No NTK approval'</span>);
        <span class="text-violet-400">return</span> res.status(403).json({ error: <span class="text-emerald-400">'Need-to-know approval required'</span> });
      }

      <span class="text-surface-500">// Check specific CRUD permission</span>
      <span class="text-violet-400">const</span> crudField = <span class="text-emerald-400">`can_${crudAction}`</span>; <span class="text-surface-500">// e.g., can_read</span>
      <span class="text-violet-400">if</span> (!ntk.rows[0][crudField]) {
        <span class="text-violet-400">await</span> auditLog(docId, token, <span class="text-emerald-400">'DENIED'</span>, <span class="text-emerald-400">`NTK lacks ${crudAction}`</span>);
        <span class="text-violet-400">return</span> res.status(403).json({
          error: <span class="text-emerald-400">`NTK approved but ${crudAction} not permitted`</span>
        });
      }
    }

    <span class="text-violet-400">await</span> auditLog(docId, token, <span class="text-emerald-400">'GRANTED'</span>, crudAction);
    next();
  };
}

<span class="text-surface-500">// Usage in routes</span>
app.get(<span class="text-emerald-400">'/api/docs/:id'</span>,
  keycloak.protect(),                      <span class="text-surface-500">// Gate 1: Role</span>
  requireClassifiedAccess(<span class="text-emerald-400">'read'</span>),       <span class="text-surface-500">// Gate 2+3: Classification + NTK</span>
  getDocument
);

app.put(<span class="text-emerald-400">'/api/docs/:id'</span>,
  keycloak.protect(<span class="text-emerald-400">'manager'</span>),           <span class="text-surface-500">// Gate 1: Manager+ role</span>
  requireClassifiedAccess(<span class="text-emerald-400">'update'</span>),    <span class="text-surface-500">// Gate 2+3: Classification + NTK</span>
  updateDocument
);</pre>
          </div>

          <!-- Key Insight Box -->
          <div class="bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-700/40 rounded-xl p-5">
            <h4 class="font-display font-bold text-sm text-rose-700 dark:text-rose-300 mb-2">üí° Why This Matters</h4>
            <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">In traditional RBAC, an executive who should only see marketing data can technically access engineering secrets because their role inherits all lower permissions. The Classification + NTK model ensures that:</p>
            <div class="grid sm:grid-cols-2 gap-3 text-xs">
              <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500">‚Ä¢</span><span class="text-surface-600 dark:text-surface-300"><strong>Lateral access is blocked:</strong> An executive in marketing cannot see finance‚Äôs PROJECT-ATLAS data without explicit NTK approval.</span></div>
              <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500">‚Ä¢</span><span class="text-surface-600 dark:text-surface-300"><strong>Least-privilege at the data level:</strong> A user might read but not modify, or create but not delete.</span></div>
              <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500">‚Ä¢</span><span class="text-surface-600 dark:text-surface-300"><strong>Compliance is auditable:</strong> Every NTK has a justification, approver, and expiration ‚Äî ready for regulatory review.</span></div>
              <div class="flex gap-2 items-start"><span class="shrink-0 text-rose-500">‚Ä¢</span><span class="text-surface-600 dark:text-surface-300"><strong>DB-level enforcement:</strong> PostgreSQL RLS ensures even application bugs cannot bypass classification/NTK checks.</span></div>
            </div>
          </div>

        </div>
      </section>

      <!-- =============== SECURITY BEST PRACTICES =============== -->
      <section id="security" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-500 to-pink-600 flex items-center justify-center text-white text-lg">üîí</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Security Best Practices</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">Production hardening</p>
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">üîê Use HTTPS Everywhere</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Never use HTTP for identity flows in production. Configure proper SSL/TLS certificates for both Keycloak and your applications.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">üóù Secure Client Secrets</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Store in environment variables or secret managers (Azure Key Vault, HashiCorp Vault). Rotate regularly and never commit to source control.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">‚úÖ Validate JWT Tokens</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Always verify JWT signatures, check expiration times, and validate the issuer and audience claims. Never trust tokens without full validation.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">‚è± Short Token Lifespans</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Access tokens: 5‚Äì15 minutes. Use refresh tokens for extended sessions. This limits exposure if a token is intercepted.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">üì± Enable MFA in Azure AD</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Add an extra security layer. Required for all admin accounts. Consider Conditional Access policies for risk-based MFA.</p>
            </div>
            <div class="bg-surface-50 dark:bg-surface-900/40 border border-surface-200 dark:border-surface-700/40 rounded-xl p-4">
              <h4 class="font-display font-bold text-sm mb-1">üìã Regular Audits</h4>
              <p class="text-xs text-surface-500 dark:text-surface-400 leading-relaxed">Review access logs monthly. Check for unused accounts. Audit role assignments. Apply the principle of least privilege everywhere.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- =============== TESTING CHECKLIST =============== -->
      <section id="checklist" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center text-white text-lg">‚úì</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Testing Checklist</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">End-to-end verification</p>
            </div>
          </div>

          <div class="space-y-2">
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Azure AD user can log into Keycloak via SSO</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">User attributes sync correctly (email, name, groups)</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Azure AD groups map to correct Keycloak roles</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Access tokens contain correct roles in realm_access.roles</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Application enforces role-based access correctly</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Cell-level security filters by classification + need-to-know</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">SSO works across multiple applications</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">User with insufficient classification level is denied access</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Executive without NTK approval is denied project data</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">NTK with read-only blocks update/delete attempts</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">PostgreSQL RLS filters classified rows at DB layer</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Logout works properly (both Keycloak and Azure AD)</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Token refresh works seamlessly</span>
            </label>
            <label class="check-item flex items-start gap-3 bg-surface-50 dark:bg-surface-900/40 rounded-xl px-4 py-3 cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800/40 transition">
              <input type="checkbox" class="mt-0.5 w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-brand-500 focus:ring-brand-500">
              <span class="text-sm text-surface-700 dark:text-surface-300">Events are logged for audit trail</span>
            </label>
          </div>
        </div>
      </section>

      <!-- =============== DATABASE SCHEMA =============== -->
      <section id="schema" class="fade-section mb-16">
        <div class="section-card bg-white dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700/50 rounded-2xl p-6 md:p-10 shadow-sm">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-white text-lg">üóÑ</div>
            <div>
              <h2 class="font-display font-800 text-2xl md:text-3xl">Database Schema</h2>
              <p class="text-sm text-surface-500 dark:text-surface-400 font-mono">PostgreSQL tables for the document repository</p>
            </div>
          </div>

          <button onclick="toggleDeepDive('schema-deep')" class="btn-glow inline-flex items-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-display font-600 px-5 py-2.5 rounded-xl transition-all duration-300 mb-4">
            <svg class="w-4 h-4 deep-arrow transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            View Full Schema SQL
          </button>
          <div id="schema-deep" class="deep-dive-content">
            <div class="code-block bg-surface-900 dark:bg-surface-950 text-emerald-400 rounded-xl p-4 overflow-x-auto">
              <pre><span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- CLASSIFICATION LEVELS (reference table)</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE classification_levels (
  level INTEGER PRIMARY KEY,      <span class="text-amber-400">-- 0..4</span>
  name VARCHAR(50) NOT NULL,       <span class="text-amber-400">-- Public, Internal, Confidential, Restricted, Top-Secret</span>
  requires_ntk BOOLEAN DEFAULT false,
  description TEXT
);

INSERT INTO classification_levels VALUES
  (0, 'Public',       false, 'Publicly available information'),
  (1, 'Internal',     false, 'General internal company data'),
  (2, 'Confidential', true,  'Sensitive business data requiring NTK'),
  (3, 'Restricted',   true,  'Highly sensitive ‚Äî M&amp;A, security audits'),
  (4, 'Top-Secret',   true,  'Board-level strategies, legal matters');

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- PROJECT CODES (what data is grouped under)</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE projects (
  code VARCHAR(50) PRIMARY KEY,    <span class="text-amber-400">-- e.g., PROJECT-ATLAS</span>
  name VARCHAR(255) NOT NULL,
  owner_id VARCHAR(255) NOT NULL,  <span class="text-amber-400">-- project owner who can grant NTK</span>
  department VARCHAR(100),
  classification_level INTEGER REFERENCES classification_levels(level),
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW()
);

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- USER CLASSIFICATION &amp; NEED-TO-KNOW</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE user_classifications (
  user_id VARCHAR(255) PRIMARY KEY,
  classification_level INTEGER REFERENCES classification_levels(level) DEFAULT 0,
  granted_by VARCHAR(255) NOT NULL,    <span class="text-amber-400">-- security officer who granted clearance</span>
  granted_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,
  notes TEXT
);

CREATE TABLE user_need_to_know (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  project_code VARCHAR(50) REFERENCES projects(code),
  status VARCHAR(20) DEFAULT 'pending', <span class="text-amber-400">-- pending, approved, revoked, expired</span>
  can_create BOOLEAN DEFAULT false,
  can_read BOOLEAN DEFAULT false,
  can_update BOOLEAN DEFAULT false,
  can_delete BOOLEAN DEFAULT false,
  approved_by VARCHAR(255),            <span class="text-amber-400">-- project owner or security officer</span>
  approved_at TIMESTAMP,
  expires_at TIMESTAMP,
  justification TEXT,                  <span class="text-amber-400">-- why the user needs access</span>
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, project_code)
);

CREATE INDEX idx_ntk_user ON user_need_to_know(user_id);
CREATE INDEX idx_ntk_project ON user_need_to_know(project_code);
CREATE INDEX idx_ntk_status ON user_need_to_know(status);

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- DOCUMENTS (with classification + project code)</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE documents (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  content TEXT,
  owner_id VARCHAR(255) NOT NULL,
  owner_email VARCHAR(255) NOT NULL,
  department VARCHAR(100),
  classification_level INTEGER REFERENCES classification_levels(level) DEFAULT 1,
  project_code VARCHAR(50) REFERENCES projects(code),  <span class="text-amber-400">-- NULL = no NTK required</span>
  is_public BOOLEAN DEFAULT false,
  deleted BOOLEAN DEFAULT false,
  deleted_at TIMESTAMP,
  deleted_by VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_documents_owner ON documents(owner_id);
CREATE INDEX idx_documents_department ON documents(department);
CREATE INDEX idx_documents_classification ON documents(classification_level);
CREATE INDEX idx_documents_project ON documents(project_code);

<span class="text-surface-500">-- Enable Row-Level Security</span>
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

<span class="text-surface-500">-- RLS: classification gate</span>
CREATE POLICY cls_gate ON documents FOR ALL
  USING (classification_level &lt;= current_setting('app.user_classification', true)::int);

<span class="text-surface-500">-- RLS: need-to-know gate (SELECT)</span>
CREATE POLICY ntk_read_gate ON documents FOR SELECT
  USING (
    project_code IS NULL
    OR EXISTS (
      SELECT 1 FROM user_need_to_know u
      WHERE u.user_id = current_setting('app.user_id', true)
        AND u.project_code = documents.project_code
        AND u.status = 'approved' AND u.can_read = true
        AND (u.expires_at IS NULL OR u.expires_at &gt; NOW())
    )
  );

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- DOCUMENT SHARES</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE document_shares (
  id SERIAL PRIMARY KEY,
  document_id INTEGER REFERENCES documents(id),
  shared_by VARCHAR(255) NOT NULL,
  shared_with_email VARCHAR(255) NOT NULL,
  permissions JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- AUDIT LOG (tracks all access &amp; NTK decisions)</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE document_audit_log (
  id SERIAL PRIMARY KEY,
  document_id INTEGER REFERENCES documents(id),
  action VARCHAR(50) NOT NULL,
  user_id VARCHAR(255) NOT NULL,
  user_email VARCHAR(255) NOT NULL,
  classification_check BOOLEAN,  <span class="text-amber-400">-- did they pass classification?</span>
  ntk_check BOOLEAN,             <span class="text-amber-400">-- did they pass need-to-know?</span>
  access_granted BOOLEAN NOT NULL,
  timestamp TIMESTAMP DEFAULT NOW(),
  details JSONB
);

CREATE INDEX idx_audit_document ON document_audit_log(document_id);
CREATE INDEX idx_audit_user ON document_audit_log(user_id);
CREATE INDEX idx_audit_timestamp ON document_audit_log(timestamp);
CREATE INDEX idx_audit_granted ON document_audit_log(access_granted);

<span class="text-surface-500">-- =============================================</span>
<span class="text-surface-500">-- USER PROFILES</span>
<span class="text-surface-500">-- =============================================</span>
CREATE TABLE user_profiles (
  user_id VARCHAR(255) PRIMARY KEY,
  classification_level INTEGER REFERENCES classification_levels(level) DEFAULT 0,
  department VARCHAR(100),
  preferences JSONB,
  bio TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);</pre>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="border-t border-surface-200 dark:border-surface-700/40 bg-white/50 dark:bg-surface-950/50 backdrop-blur-sm py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 text-center">
    <p class="text-xs text-surface-400 dark:text-surface-500 font-mono">Azure AD (Entra ID) + Keycloak Federation Guide ¬∑ OIDC ¬∑ OAuth2 ¬∑ RBAC ¬∑ Classification ¬∑ Need-to-Know ¬∑ Cell-Level Security ¬∑ SSO</p>
  </div>
</footer>

<!-- ===== BACK TO TOP ===== -->
<button id="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})" class="fixed bottom-6 right-6 w-10 h-10 rounded-full bg-brand-500 text-white shadow-lg shadow-brand-500/30 flex items-center justify-center opacity-0 translate-y-4 transition-all duration-300 hover:bg-brand-600 z-40" aria-label="Back to top">
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
</button>

<!-- ===== JAVASCRIPT ===== -->
<script>
// === TABLE OF CONTENTS DATA ===
const tocSections = [
  { id: 'architecture', label: 'Architecture Overview', icon: 'üèó' },
  { id: 'phase1', label: 'P1 ¬∑ Azure AD Setup', icon: '‚òÅÔ∏è' },
  { id: 'phase2', label: 'P2 ¬∑ Keycloak Setup', icon: 'üîë' },
  { id: 'phase3', label: 'P3 ¬∑ Federation', icon: 'üîÑ' },
  { id: 'phase4', label: 'P4 ¬∑ RBAC Setup', icon: 'üõ°' },
  { id: 'phase5', label: 'P5 ¬∑ Cell-Level Security', icon: 'üî¨' },
  { id: 'phase6', label: 'P6 ¬∑ SSO Configuration', icon: 'üîó' },
  { id: 'phase7', label: 'P7 ¬∑ App Implementation', icon: 'üíª' },
  { id: 'phase8', label: 'P8 ¬∑ Advanced Security', icon: 'üîí' },
  { id: 'phase9', label: 'P9 ¬∑ Monitoring', icon: 'üìä' },
  { id: 'demo-setup', label: 'Demo Setup', icon: 'üß™' },
  { id: 'access-matrix', label: 'Access Matrix', icon: 'üìã' },
  { id: 'classification-ntk', label: 'Classification & NTK', icon: 'üè∑Ô∏è' },
  { id: 'security', label: 'Best Practices', icon: 'üîê' },
  { id: 'checklist', label: 'Testing Checklist', icon: '‚úì' },
  { id: 'schema', label: 'Database Schema', icon: 'üóÑ' },
];

// === BUILD TOC ===
function buildToc(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = tocSections.map(s =>
    `<a href="#${s.id}" class="toc-link flex items-center gap-2.5 px-3 py-2 text-xs rounded-lg border-l-2 border-transparent text-surface-600 dark:text-surface-400 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-surface-100 dark:hover:bg-surface-800/40 transition-all duration-200" data-target="${s.id}" onclick="onTocClick(event)">
      <span class="text-[0.7rem]">${s.icon}</span>
      <span class="font-display font-500">${s.label}</span>
    </a>`
  ).join('');
}
buildToc('toc-nav');
buildToc('mobile-toc-links');

function onTocClick(e) {
  closeMobileToc();
}

// === DARK MODE TOGGLE ===
const html = document.documentElement;
const toggle = document.getElementById('theme-toggle');
const knob = document.getElementById('theme-knob');
const sunIcon = document.getElementById('sun-icon');
const moonIcon = document.getElementById('moon-icon');

function setTheme(dark) {
  if (dark) {
    html.classList.add('dark');
    knob.style.transform = 'translateX(28px)';
    sunIcon.classList.add('hidden');
    moonIcon.classList.remove('hidden');
    localStorage.setItem('theme', 'dark');
  } else {
    html.classList.remove('dark');
    knob.style.transform = 'translateX(0)';
    sunIcon.classList.remove('hidden');
    moonIcon.classList.add('hidden');
    localStorage.setItem('theme', 'light');
  }
}

// Init theme
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
setTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));

toggle.addEventListener('click', () => {
  setTheme(!html.classList.contains('dark'));
});

// === PROGRESS BAR ===
const progressBar = document.getElementById('progress-bar');
function updateProgress() {
  const scrollTop = window.scrollY;
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
  progressBar.style.width = progress + '%';
}

// === ACTIVE TOC TRACKING ===
function updateActiveToc() {
  const scrollY = window.scrollY + 120;
  let activeId = tocSections[0].id;
  for (const section of tocSections) {
    const el = document.getElementById(section.id);
    if (el && el.offsetTop <= scrollY) {
      activeId = section.id;
    }
  }
  document.querySelectorAll('.toc-link').forEach(link => {
    link.classList.toggle('active', link.dataset.target === activeId);
  });
}

// === BACK TO TOP BUTTON ===
const backToTop = document.getElementById('back-to-top');
function updateBackToTop() {
  if (window.scrollY > 600) {
    backToTop.style.opacity = '1';
    backToTop.style.transform = 'translateY(0)';
  } else {
    backToTop.style.opacity = '0';
    backToTop.style.transform = 'translateY(16px)';
  }
}

// === FADE-IN ON SCROLL ===
const fadeSections = document.querySelectorAll('.fade-section');
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('visible');
    }
  });
}, { threshold: 0.08, rootMargin: '0px 0px -40px 0px' });
fadeSections.forEach(el => observer.observe(el));

// === SCROLL EVENT ===
let ticking = false;
window.addEventListener('scroll', () => {
  if (!ticking) {
    requestAnimationFrame(() => {
      updateProgress();
      updateActiveToc();
      updateBackToTop();
      ticking = false;
    });
    ticking = true;
  }
});

// === DEEP DIVE TOGGLE ===
function toggleDeepDive(id) {
  const el = document.getElementById(id);
  const btn = el.previousElementSibling;
  const arrow = btn.querySelector('.deep-arrow');
  el.classList.toggle('expanded');
  if (el.classList.contains('expanded')) {
    arrow.style.transform = 'rotate(180deg)';
  } else {
    arrow.style.transform = 'rotate(0deg)';
  }
}

// === MOBILE TOC ===
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const mobileToc = document.getElementById('mobile-toc');
const mobileTocOverlay = document.getElementById('mobile-toc-overlay');

mobileMenuBtn.addEventListener('click', () => {
  mobileToc.classList.add('open');
  mobileTocOverlay.classList.remove('hidden');
});

function closeMobileToc() {
  mobileToc.classList.remove('open');
  mobileTocOverlay.classList.add('hidden');
}

// Init
updateProgress();
updateActiveToc();

// === DOWNLOAD FUNCTIONALITY ===
const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell,
        HeadingLevel, AlignmentType, BorderStyle, WidthType, ShadingType,
        PageBreak, Header, Footer, PageNumber, LevelFormat } = docx;

// Section content data for DOCX generation
const sectionData = [
  {
    id: 'architecture',
    title: 'Architecture Overview',
    content: [
      { type: 'p', text: 'This guide walks through building an enterprise-grade identity and access management system connecting Microsoft\'s cloud identity platform with Keycloak as an identity broker.' },
      { type: 'h3', text: 'Core Components' },
      { type: 'bullet', text: 'Azure AD (Microsoft Entra ID): Primary Identity Provider ‚Äî authenticates users against Microsoft\'s cloud directory.' },
      { type: 'bullet', text: 'Keycloak: Identity Broker & Policy Enforcement ‚Äî sits between Azure AD and your applications.' },
      { type: 'bullet', text: 'OIDC / OAuth 2.0: Federation protocol connecting Azure AD to Keycloak via token exchange.' },
      { type: 'bullet', text: 'RBAC: Role-Based Access Control ‚Äî users assigned roles that determine permitted actions.' },
      { type: 'bullet', text: 'Cell-Level Security: Fine-grained data access control based on user attributes.' },
      { type: 'bullet', text: 'SSO: Single Sign-On ‚Äî authenticate once, access all connected applications.' },
      { type: 'h3', text: 'Authentication Flow' },
      { type: 'number', text: 'User visits your application ‚Äî app detects no session and redirects to Keycloak.' },
      { type: 'number', text: 'Keycloak presents login options ‚Äî user sees "Sign in with Microsoft Azure AD."' },
      { type: 'number', text: 'Redirect to Azure AD ‚Äî Keycloak initiates OIDC Authorization Code flow.' },
      { type: 'number', text: 'User authenticates at Azure AD ‚Äî enters credentials (and MFA if configured).' },
      { type: 'number', text: 'Azure AD returns authorization code ‚Äî redirects back to Keycloak broker endpoint.' },
      { type: 'number', text: 'Keycloak exchanges code for tokens ‚Äî calls Azure AD token endpoint with code + secret.' },
      { type: 'number', text: 'Keycloak processes claims and maps roles ‚Äî extracts groups, assigns Keycloak roles.' },
      { type: 'number', text: 'Keycloak creates session & tokens ‚Äî issues JWT with roles, department, custom claims.' },
      { type: 'number', text: 'Application enforces RBAC & cell-level security ‚Äî reads JWT, grants/denies access.' },
      { type: 'p', text: 'Key concept: Keycloak acts as a broker ‚Äî it federates identity from Azure AD but maintains its own sessions and tokens. This decouples your applications from any single identity provider.' },
    ]
  },
  {
    id: 'phase1',
    title: 'Phase 1: Azure AD (Entra ID) Setup',
    content: [
      { type: 'h3', text: 'Step 1: Create Azure AD Tenant' },
      { type: 'p', text: 'Navigate to portal.azure.com. Your Azure AD tenant is your organization\'s dedicated instance where all users, groups, and apps reside. Go to Azure Active Directory ‚Üí Overview and note your Tenant ID and Primary Domain (e.g., yourcompany.onmicrosoft.com).' },
      { type: 'h3', text: 'Step 2: Create Users and Groups' },
      { type: 'p', text: 'Groups are the foundation of RBAC. Create groups that mirror organizational roles:' },
      { type: 'bullet', text: 'Admin-FullAccess ‚Äî Full system access' },
      { type: 'bullet', text: 'Manager-ReadWrite ‚Äî Read/write to specific data cells' },
      { type: 'bullet', text: 'User-ReadOnly ‚Äî Read-only access' },
      { type: 'bullet', text: 'Finance-Department ‚Äî Cell-level access to finance data' },
      { type: 'bullet', text: 'HR-Department ‚Äî Cell-level access to HR data' },
      { type: 'h3', text: 'Step 3: Register Application in Azure AD' },
      { type: 'p', text: 'Go to App Registrations ‚Üí New Registration. Name: Keycloak-Federation. Set supported account types to "Accounts in this organizational directory only." Set Redirect URI to: http://localhost:8080/realms/master/broker/azuread/endpoint. Capture the Application (client) ID and Directory (tenant) ID.' },
      { type: 'h3', text: 'Step 4: Create Client Secret' },
      { type: 'p', text: 'Go to Certificates & Secrets ‚Üí New Client Secret. Set description to Keycloak-Secret with 24-month expiry. IMPORTANT: Copy the secret VALUE immediately ‚Äî you cannot retrieve it later.' },
      { type: 'h3', text: 'Step 5: Configure API Permissions' },
      { type: 'p', text: 'Add Microsoft Graph delegated permissions: openid, profile, email, User.Read, GroupMember.Read.All. Then click "Grant admin consent for [Your Organization]."' },
      { type: 'h3', text: 'Step 6: Configure Token Claims' },
      { type: 'p', text: 'Add optional claims (email, family_name, given_name) to the ID token. Add groups claim selecting Security groups with Group ID format.' },
      { type: 'h3', text: 'Deep Dive: Azure AD Concepts' },
      { type: 'p', text: 'Tenant: A dedicated, isolated instance of Azure AD. Every user, group, and app registration lives within a specific tenant identified by a GUID.' },
      { type: 'p', text: 'App Registration defines identity configuration (client ID, secrets, redirect URIs). Enterprise Application controls who can use the app and sign-in policies.' },
      { type: 'p', text: 'Delegated permissions act on behalf of a signed-in user. Application permissions are for background services. For Keycloak federation, use delegated permissions.' },
      { type: 'p', text: 'Group claims in tokens avoid extra API calls to Microsoft Graph during login. Keycloak receives group memberships directly and maps them to roles immediately.' },
    ]
  },
  {
    id: 'phase2',
    title: 'Phase 2: Keycloak Installation & Setup',
    content: [
      { type: 'h3', text: 'Step 7: Install Keycloak' },
      { type: 'p', text: 'Download Keycloak from GitHub releases. Extract, set KEYCLOAK_ADMIN and KEYCLOAK_ADMIN_PASSWORD environment variables. Start with ./bin/kc.sh start-dev for development mode. Access admin console at http://localhost:8080.' },
      { type: 'code', text: 'wget https://github.com/keycloak/keycloak/releases/download/23.0.0/keycloak-23.0.0.zip\nunzip keycloak-23.0.0.zip && cd keycloak-23.0.0\nexport KEYCLOAK_ADMIN=admin\nexport KEYCLOAK_ADMIN_PASSWORD=admin123!\n./bin/kc.sh start-dev' },
      { type: 'h3', text: 'Step 8: Create Keycloak Realm' },
      { type: 'p', text: 'Create realm named "enterprise-apps". Set User Profile Enabled: ON, User Registration: OFF (users come from Azure AD), Remember Me: ON.' },
      { type: 'h3', text: 'Deep Dive: Keycloak Concepts' },
      { type: 'p', text: 'Realms are isolated tenants ‚Äî completely separate user pools, roles, and groups. The "master" realm is for admin; create separate realms per application.' },
      { type: 'p', text: 'Dev mode uses embedded H2 database with no HTTPS. Production mode requires external PostgreSQL, TLS certificates, and hostname configuration.' },
      { type: 'p', text: 'As a broker, Keycloak delegates authentication to external IdPs while managing its own sessions and tokens. Your apps only talk to Keycloak, never directly to Azure AD.' },
    ]
  },
  {
    id: 'phase3',
    title: 'Phase 3: Federation Configuration',
    content: [
      { type: 'h3', text: 'Step 9: Add Azure AD as Identity Provider' },
      { type: 'p', text: 'In Keycloak, add OpenID Connect v1.0 identity provider with alias "azuread". Set Discovery Endpoint to: https://login.microsoftonline.com/{TENANT_ID}/v2.0/.well-known/openid-configuration. Provide Client ID and Secret. Set Default Scopes: openid profile email.' },
      { type: 'p', text: 'Configure mappers: email (from email claim), firstName (from given_name), lastName (from family_name), azure-groups (from groups claim).' },
      { type: 'h3', text: 'Step 10: Update Azure AD Redirect URI' },
      { type: 'p', text: 'Copy Keycloak\'s broker redirect URI and add it to Azure AD App Registration ‚Üí Authentication ‚Üí Redirect URIs. Example: http://localhost:8080/realms/enterprise-apps/broker/azuread/endpoint.' },
      { type: 'h3', text: 'Deep Dive: OIDC & Federation' },
      { type: 'p', text: 'The .well-known/openid-configuration endpoint returns a JSON document with all endpoints, supported scopes, claims, and signing algorithms. Keycloak reads this once during setup.' },
      { type: 'p', text: 'Mappers translate between Azure AD claim names and Keycloak attribute names. Without proper mappers, user profiles would be incomplete and group-to-role mapping won\'t work.' },
      { type: 'p', text: 'Sync Mode IMPORT creates users on first login only. FORCE updates attributes on every login. Use FORCE for groups and department to keep them in sync.' },
    ]
  },
  {
    id: 'phase4',
    title: 'Phase 4: RBAC Setup',
    content: [
      { type: 'h3', text: 'Step 11: Create Keycloak Roles' },
      { type: 'p', text: 'Create realm roles: admin, manager, user, finance-analyst, hr-specialist. Create composite roles where manager inherits employee, director inherits manager, etc.' },
      { type: 'code', text: 'admin (full access)\n  ‚îî‚îÄ‚îÄ executive\n      ‚îî‚îÄ‚îÄ director\n          ‚îî‚îÄ‚îÄ manager\n              ‚îî‚îÄ‚îÄ employee (base level)' },
      { type: 'h3', text: 'Step 12: Map Azure AD Groups to Keycloak Roles' },
      { type: 'p', text: 'Use Advanced Claim to Role mappers. For each Azure AD group, map the Group Object ID to a Keycloak role. Example: Admin-FullAccess group ‚Üí admin role, Manager-ReadWrite ‚Üí manager role.' },
      { type: 'h3', text: 'Role Composition Detail' },
      { type: 'bullet', text: 'Employee: document:read, document:create, profile:read-own, profile:update-own, access-public, access-internal' },
      { type: 'bullet', text: 'Manager: employee + document:update, document:share, profile:read-team, access-confidential' },
      { type: 'bullet', text: 'Director: manager + document:delete, profile:read-dept, access-restricted, admin:audit-logs' },
      { type: 'bullet', text: 'Executive: director + profile:read-all, access-top-secret, admin:user-management' },
    ]
  },
  {
    id: 'phase5',
    title: 'Phase 5: App Integration & Cell-Level Security',
    content: [
      { type: 'h3', text: 'Step 13: Create Keycloak Client' },
      { type: 'p', text: 'Create client "my-application" with OpenID Connect type. Enable Client Authentication, Authorization, Standard Flow, and Direct Access Grants. Set Root URL, Valid Redirect URIs, and Web Origins to your application.' },
      { type: 'h3', text: 'Step 14: Configure Client Scopes for RBAC' },
      { type: 'p', text: 'Create custom client scope "roles" with User Realm Role mapper. Set Token Claim Name to realm_access.roles. Add to ID token, access token, and userinfo.' },
      { type: 'h3', text: 'Step 15: Cell-Level Security' },
      { type: 'p', text: 'Approach 1: User Attributes ‚Äî add department, region, data_classification attributes to users. Map into access tokens via client scope mappers.' },
      { type: 'p', text: 'Approach 2: Authorization Services ‚Äî define Resources, Scopes, Policies, and Permissions in Keycloak. Policies can be role-based, JavaScript-based, or time-based.' },
      { type: 'p', text: 'Data Classification Levels: Public (everyone), Internal (employees), Confidential (managers+), Restricted (directors+), Top-Secret (executives only).' },
      { type: 'p', text: 'PostgreSQL Row-Level Security: Use ALTER TABLE ... ENABLE ROW LEVEL SECURITY with policies that filter rows based on session variables set from the JWT token.' },
    ]
  },
  {
    id: 'phase6',
    title: 'Phase 6: Single Sign-On (SSO)',
    content: [
      { type: 'h3', text: 'Step 16: Configure SSO Session Settings' },
      { type: 'p', text: 'SSO Session Idle: 30 minutes. SSO Session Max: 10 hours. Remember Me Idle: 7 days. Remember Me Max: 30 days.' },
      { type: 'p', text: 'Token Lifespans: Access Token: 5 minutes. Implicit Flow: 15 minutes. Client Login Timeout: 1 minute.' },
      { type: 'h3', text: 'Step 17: Test SSO Flow' },
      { type: 'p', text: 'Navigate to Keycloak account console. Click "Microsoft Azure AD." Should redirect to Azure AD, then back to Keycloak. Verify user attributes, role mappings, and token contents.' },
      { type: 'p', text: 'Use jwt.io to decode the access token and verify it contains user info, roles in realm_access.roles, and custom attributes.' },
      { type: 'h3', text: 'How SSO Works' },
      { type: 'p', text: 'When a user logs into App A, Keycloak creates a session cookie. When visiting App B, Keycloak sees the existing session and immediately issues new tokens ‚Äî no login prompt.' },
      { type: 'p', text: 'Short access token lifespans (5 min) limit damage from leaked tokens. Refresh tokens allow seamless re-authentication behind the scenes.' },
    ]
  },
  {
    id: 'phase7-9',
    title: 'Phases 7-9: Implementation, Advanced Security & Monitoring',
    content: [
      { type: 'h3', text: 'Phase 7: Application Implementation (Node.js)' },
      { type: 'p', text: 'Use keycloak-connect middleware for Express.js. keycloak.protect() checks authentication. keycloak.protect("admin") verifies realm role.' },
      { type: 'code', text: 'app.get("/secure", keycloak.protect(), handler);\napp.get("/admin", keycloak.protect("admin"), handler);\napp.get("/api/finance", keycloak.protect(), (req, res) => {\n  const token = req.kauth.grant.access_token.content;\n  if (token.realm_access.roles.includes("finance-analyst")\n      || token.department === "finance") {\n    // Grant access\n  }\n});' },
      { type: 'h3', text: 'Phase 8: PostgreSQL Row-Level Security' },
      { type: 'code', text: 'ALTER TABLE financial_records ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY department_isolation ON financial_records\n  USING (department = current_setting(\'app.user_department\'));\n\n-- In app: set from JWT before queries\nawait db.query("SET app.user_department = $1", [token.department]);' },
      { type: 'h3', text: 'Phase 9: Monitoring & Troubleshooting' },
      { type: 'p', text: 'Enable Keycloak event logging: Realm Settings ‚Üí Events ‚Üí Save Login Events and Admin Events.' },
      { type: 'p', text: 'Common issues: Redirect URI mismatch (check exact match), expired client secret, missing admin consent, group claims not configured, missing client scope role mappers.' },
    ]
  },
  {
    id: 'security-checklist',
    title: 'Security Best Practices & Testing Checklist',
    content: [
      { type: 'h3', text: 'Security Best Practices' },
      { type: 'bullet', text: 'Use HTTPS everywhere ‚Äî never HTTP for identity flows in production.' },
      { type: 'bullet', text: 'Secure client secrets ‚Äî store in environment variables or secrets managers. Rotate regularly.' },
      { type: 'bullet', text: 'Validate JWT tokens ‚Äî verify signatures, expiration, issuer, and audience claims.' },
      { type: 'bullet', text: 'Short token lifespans ‚Äî access tokens 5-15 minutes. Use refresh tokens for extended sessions.' },
      { type: 'bullet', text: 'Enable MFA in Azure AD ‚Äî required for admin accounts.' },
      { type: 'bullet', text: 'Regular audits ‚Äî review access logs monthly. Audit role assignments. Principle of least privilege.' },
      { type: 'h3', text: 'Testing Checklist' },
      { type: 'number', text: 'Azure AD user can log into Keycloak via SSO' },
      { type: 'number', text: 'User attributes sync correctly (email, name, groups)' },
      { type: 'number', text: 'Azure AD groups map to correct Keycloak roles' },
      { type: 'number', text: 'Access tokens contain correct roles in realm_access.roles' },
      { type: 'number', text: 'Application enforces role-based access correctly' },
      { type: 'number', text: 'Cell-level security filters by classification + need-to-know' },
      { type: 'number', text: 'SSO works across multiple applications' },
      { type: 'number', text: 'Logout works properly (both Keycloak and Azure AD)' },
      { type: 'number', text: 'Token refresh works seamlessly' },
      { type: 'number', text: 'Events are logged for audit trail' },
    ]
  },
  {
    id: 'demo-setup',
    title: 'Hands-On Demo Setup: Entra External ID + Docker Compose',
    content: [
      { type: 'h3', text: 'What is Microsoft Entra External ID?' },
      { type: 'p', text: 'Microsoft Entra External ID is the next-generation Customer Identity & Access Management (CIAM) solution from Microsoft, replacing Azure AD B2C. It creates a separate "external tenant" ‚Äî isolated from your workforce directory ‚Äî designed for consumer and partner-facing applications. Free for the first 50,000 monthly active users.' },
      { type: 'bullet', text: 'External Tenant: A dedicated directory for customer/partner identities, completely separate from your workforce Entra ID tenant.' },
      { type: 'bullet', text: 'User Flows: Built-in sign-up/sign-in flows with customizable branding, MFA, and social provider federation.' },
      { type: 'bullet', text: 'OIDC Standard: Fully OIDC-compliant. Keycloak federates via the standard discovery endpoint.' },
      { type: 'bullet', text: 'Discovery Domain: External tenants use *.ciamlogin.com (e.g., mydemocustomers.ciamlogin.com/{tenant-id}/v2.0/.well-known/openid-configuration).' },
      { type: 'h3', text: 'Part A: Entra External ID ‚Äî Azure Portal Setup' },
      { type: 'p', text: 'Step A1: Create an External Tenant. Sign in to https://entra.microsoft.com. Navigate to Entra ID ‚Üí Overview ‚Üí Manage tenants ‚Üí Create. Select "External" (not Workforce). Enter a Tenant Name and unique domain prefix. Provisioning takes up to 30 minutes.' },
      { type: 'p', text: 'Step A2: Switch to the external tenant using Settings ‚Üí Directories + subscriptions. Run the Get Started guide to configure sign-in methods (Email + password or Email + OTP) and branding.' },
      { type: 'p', text: 'Step A3: Register two app registrations ‚Äî "Keycloak-Broker" (Web redirect: http://localhost:8080/realms/demo/broker/entra-external/endpoint) and "Demo-SPA-Client" (SPA redirect: http://localhost:3001/callback). Both single-tenant.' },
      { type: 'p', text: 'Step A4: Create a client secret for Keycloak-Broker. Copy the Value immediately. Step A5: Configure API permissions ‚Äî add Microsoft Graph delegated: openid, profile, email, offline_access. Grant admin consent.' },
      { type: 'p', text: 'Step A6: Create a User Flow (demo-signup-signin) with Email + password. Bind both app registrations to the flow.' },
      { type: 'h3', text: 'Part B: Docker Compose Stack' },
      { type: 'p', text: 'The local stack runs: Keycloak (identity broker, port 8080), Node.js Express API (resource server, port 4000), Demo Client A (SPA, port 3001), Demo Client B (SPA, port 3002), and PostgreSQL for Keycloak storage.' },
      { type: 'code', text: '# .env ‚Äî fill from Azure Portal\nENTRA_TENANT_ID=aaaabbbb-1111-2222-3333-ccccddddeeee\nENTRA_CLIENT_ID=11112222-aaaa-bbbb-cccc-333344445555\nENTRA_CLIENT_SECRET=your-secret-here\nENTRA_DOMAIN=mydemocustomers\nKC_DB_PASSWORD=supersecretdb\nKC_ADMIN=admin\nKC_ADMIN_PASSWORD=admin123!' },
      { type: 'code', text: '# Launch\ndocker compose up -d --build\n\n# Endpoints:\n# Keycloak Admin ‚Üí http://localhost:8080\n# Client A       ‚Üí http://localhost:3001\n# Client B       ‚Üí http://localhost:3002\n# API            ‚Üí http://localhost:4000/api/public' },
      { type: 'h3', text: 'Part C: Keycloak Federation Configuration' },
      { type: 'number', text: 'Create Realm "demo" in Keycloak admin console.' },
      { type: 'number', text: 'Add Identity Provider ‚Üí OpenID Connect v1.0. Alias: entra-external. Paste the ciamlogin.com discovery URL. Enter Client ID and Secret.' },
      { type: 'number', text: 'Add Attribute Mappers: email, given_name ‚Üí firstName, family_name ‚Üí lastName. Sync Mode: FORCE.' },
      { type: 'number', text: 'Create two public OIDC clients: client-a (port 3001) and client-b (port 3002).' },
      { type: 'number', text: 'Create realm roles (employee, manager, admin) and a "roles" client scope with User Realm Role mapper.' },
      { type: 'number', text: 'Test: Open localhost:3001 ‚Üí click "Sign in with Entra External ID" ‚Üí authenticate ‚Üí verify SSO by opening localhost:3002 (no login prompt).' },
      { type: 'h3', text: 'How the Authentication Flow Works' },
      { type: 'p', text: 'User visits Client A ‚Üí keycloak-js redirects to Keycloak ‚Üí user clicks "Entra External ID" ‚Üí Keycloak sends OIDC auth request to ciamlogin.com ‚Üí Entra presents branded sign-in ‚Üí user authenticates ‚Üí Entra returns auth code to Keycloak broker endpoint ‚Üí Keycloak exchanges code for tokens (server-to-server) ‚Üí attribute mappers populate user profile ‚Üí Keycloak creates SSO session and issues its own JWT ‚Üí Client A receives Keycloak JWT ‚Üí calls API with Bearer token. Client B picks up the SSO session automatically.' },
      { type: 'h3', text: 'Why Broker Through Keycloak?' },
      { type: 'bullet', text: 'Role Management: Entra External ID lacks Keycloak-style realm roles and composite roles.' },
      { type: 'bullet', text: 'Multi-IdP Support: Add Google, SAML, LDAP alongside Entra without changing app code.' },
      { type: 'bullet', text: 'Fine-Grained Authorization: Keycloak Authorization Services and UMA support.' },
      { type: 'bullet', text: 'Portability: Switch IdPs by reconfiguring only the Keycloak broker ‚Äî apps are untouched.' },
    ]
  },
  {
    id: 'access-matrix',
    title: 'Access Control Matrix',
    content: [
      { type: 'p', text: 'Summary of permissions by role across the document repository system:' },
      { type: 'table', headers: ['Role', 'Create', 'Read Own', 'Public', 'Team', 'Dept', 'All', 'Edit Own', 'Edit Team', 'Delete', 'Share', 'Audit'],
        rows: [
          ['Employee',  '‚úì', '‚úì', '‚úì', '‚úó', '~', '‚úó', '‚úì', '‚úó', '‚úì', '‚úó', '‚úó'],
          ['Manager',   '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úó', '‚úì', '‚úì', '~', '‚úì', '‚úó'],
          ['Director',  '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì'],
          ['Executive', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì', '‚úì'],
        ]
      },
      { type: 'p', text: '~ = Limited by classification level and department membership' },
    ]
  },
  {
    id: 'database-schema',
    title: 'Database Schema',
    content: [
      { type: 'p', text: 'PostgreSQL schema for the document repository system with RBAC and cell-level security.' },
      { type: 'code', text: 'CREATE TABLE classification_levels (\n  level INTEGER PRIMARY KEY,  -- 0..4\n  name VARCHAR(50) NOT NULL,\n  requires_ntk BOOLEAN DEFAULT false,\n  description TEXT\n);\n\nCREATE TABLE projects (\n  code VARCHAR(50) PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  owner_id VARCHAR(255) NOT NULL,\n  department VARCHAR(100),\n  classification_level INTEGER,\n  status VARCHAR(20) DEFAULT \'active\'\n);' },
      { type: 'code', text: 'CREATE TABLE user_classifications (\n  user_id VARCHAR(255) PRIMARY KEY,\n  classification_level INTEGER DEFAULT 0,\n  granted_by VARCHAR(255) NOT NULL,\n  granted_at TIMESTAMP DEFAULT NOW(),\n  expires_at TIMESTAMP\n);\n\nCREATE TABLE user_need_to_know (\n  id SERIAL PRIMARY KEY,\n  user_id VARCHAR(255) NOT NULL,\n  project_code VARCHAR(50) REFERENCES projects(code),\n  status VARCHAR(20) DEFAULT \'pending\',\n  can_create BOOLEAN DEFAULT false,\n  can_read BOOLEAN DEFAULT false,\n  can_update BOOLEAN DEFAULT false,\n  can_delete BOOLEAN DEFAULT false,\n  approved_by VARCHAR(255),\n  expires_at TIMESTAMP,\n  justification TEXT,\n  UNIQUE(user_id, project_code)\n);' },
      { type: 'code', text: 'CREATE TABLE documents (\n  id SERIAL PRIMARY KEY,\n  title VARCHAR(255) NOT NULL,\n  content TEXT,\n  owner_id VARCHAR(255) NOT NULL,\n  owner_email VARCHAR(255) NOT NULL,\n  department VARCHAR(100),\n  classification_level INTEGER DEFAULT 1,\n  project_code VARCHAR(50) REFERENCES projects(code),\n  is_public BOOLEAN DEFAULT false,\n  deleted BOOLEAN DEFAULT false,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);' },
      { type: 'code', text: 'CREATE TABLE document_shares (\n  id SERIAL PRIMARY KEY,\n  document_id INTEGER REFERENCES documents(id),\n  shared_by VARCHAR(255) NOT NULL,\n  shared_with_email VARCHAR(255) NOT NULL,\n  permissions JSONB,\n  created_at TIMESTAMP DEFAULT NOW()\n);' },
      { type: 'code', text: 'CREATE TABLE document_audit_log (\n  id SERIAL PRIMARY KEY,\n  document_id INTEGER REFERENCES documents(id),\n  action VARCHAR(50) NOT NULL,\n  user_id VARCHAR(255) NOT NULL,\n  user_email VARCHAR(255) NOT NULL,\n  timestamp TIMESTAMP DEFAULT NOW(),\n  details JSONB\n);' },
      { type: 'code', text: 'CREATE TABLE user_profiles (\n  user_id VARCHAR(255) PRIMARY KEY,\n  preferences JSONB,\n  bio TEXT,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);' },
    ]
  }
];

// Build docx content from section data
// deepDiveMap maps sectionData id ‚Üí deep-dive panel DOM id
const deepDiveMap = {
  'architecture': 'arch-deep',
  'phase1': 'phase1-deep',
  'phase2': 'phase2-deep',
  'phase3': 'phase3-deep',
  'phase4': 'phase4-deep',
  'phase5': 'phase5-deep',
  'phase6': 'phase6-deep',
  'phase7-9': 'phase7-deep',
  'demo-setup': 'demo-deep',
  'database-schema': 'schema-deep',
  'classification-ntk': null,
};

/**
 * Extract deep dive content from the DOM and return it as an
 * array of {type, text} items matching the sectionData format.
 */
function extractDeepDive(sectionId) {
  const panelId = deepDiveMap[sectionId];
  if (!panelId) return [];
  const wrapper = document.getElementById(panelId);
  if (!wrapper) return [];
  const panel = wrapper.querySelector('.deep-dive-panel');
  if (!panel) return [];

  const items = [];

  // Walk top-level children of the panel
  const walk = (root) => {
    for (const node of root.children) {
      const tag = node.tagName?.toLowerCase();

      // h4 headings ‚Üí h3 items (sub-headings in docx)
      if (tag === 'h4') {
        const text = node.textContent.replace(/^[üîÑüî¨üîóüíªüîíüìäüß™üóÑÔ∏è\s]+/, '').trim();
        if (text) items.push({ type: 'h3', text });
        continue;
      }

      // paragraphs
      if (tag === 'p') {
        const text = node.textContent.trim();
        if (text.length > 5) items.push({ type: 'p', text });
        continue;
      }

      // pre / code blocks
      if (tag === 'pre') {
        items.push({ type: 'code', text: node.textContent.trim() });
        continue;
      }

      // inner-block div (highlighted box) ‚Äî treat as paragraph
      if (node.classList?.contains('inner-block')) {
        const text = node.textContent.trim();
        if (text) items.push({ type: 'p', text });
        continue;
      }

      // div containers ‚Äî recurse one level
      if (tag === 'div') {
        // Check for numbered flow steps (demo-deep uses flex items with number spans)
        const numSpan = node.querySelector(':scope > span.shrink-0');
        if (numSpan && /^\d+\.?$/.test(numSpan.textContent.trim())) {
          const rest = node.textContent.replace(numSpan.textContent, '').trim();
          if (rest) items.push({ type: 'number', text: rest });
          continue;
        }
        walk(node);
      }

      // space-y containers
      if (tag === 'div' && (node.classList?.contains('space-y-3') || node.classList?.contains('space-y-4') || node.classList?.contains('space-y-2') || node.classList?.contains('space-y-5'))) {
        // Already handled by generic div recurse above
        continue;
      }
    }
  };

  walk(panel);
  return items;
}

function buildDocxParagraphs(sections, numbering, includeDeepDives) {
  const paras = [];
  const border = { style: BorderStyle.SINGLE, size: 1, color: 'BBBBBB' };
  const borders = { top: border, bottom: border, left: border, right: border };

  // Helper: render an array of {type, text} items into docx paragraphs
  function renderItems(contentArr, isDeepDive) {
    const ddColor = isDeepDive ? '1a4a6e' : undefined;
    const ddItalic = isDeepDive;
    contentArr.forEach(item => {
      if (item.type === 'h3') {
        paras.push(new Paragraph({
          heading: HeadingLevel.HEADING_2,
          spacing: { before: 240, after: 120 },
          children: [new TextRun({
            text: item.text, bold: true, size: 26, font: 'Arial',
            ...(isDeepDive ? { color: '1E6B71' } : {})
          })]
        }));
      } else if (item.type === 'p') {
        paras.push(new Paragraph({
          spacing: { after: 160 },
          ...(isDeepDive ? { indent: { left: 180 } } : {}),
          children: [new TextRun({ text: item.text, size: 22, font: 'Arial', ...(isDeepDive ? { color: '475569' } : {}) })]
        }));
      } else if (item.type === 'bullet') {
        paras.push(new Paragraph({
          numbering: { reference: 'bullets', level: 0 },
          spacing: { after: 80 },
          children: [new TextRun({ text: item.text, size: 22, font: 'Arial' })]
        }));
      } else if (item.type === 'number') {
        paras.push(new Paragraph({
          numbering: { reference: 'numbers', level: 0 },
          spacing: { after: 80 },
          children: [new TextRun({ text: item.text, size: 22, font: 'Arial' })]
        }));
      } else if (item.type === 'code') {
        paras.push(new Paragraph({
          spacing: { before: 120, after: 120 },
          shading: { fill: 'F1F5F9', type: ShadingType.CLEAR },
          indent: { left: 360, right: 360 },
          children: item.text.split('\n').flatMap((line, i, arr) => {
            const runs = [new TextRun({ text: line, font: 'Courier New', size: 18 })];
            if (i < arr.length - 1) runs.push(new TextRun({ break: 1 }));
            return runs;
          })
        }));
      } else if (item.type === 'table') {
        const headerRow = new TableRow({
          tableHeader: true,
          children: item.headers.map(h => new TableCell({
            borders,
            shading: { fill: '1E6B71', type: ShadingType.CLEAR },
            margins: { top: 60, bottom: 60, left: 80, right: 80 },
            width: { size: Math.floor(9360 / item.headers.length), type: WidthType.DXA },
            children: [new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: h, bold: true, size: 18, font: 'Arial', color: 'FFFFFF' })] })]
          }))
        });
        const dataRows = item.rows.map(row => new TableRow({
          children: row.map((cell, ci) => new TableCell({
            borders,
            margins: { top: 40, bottom: 40, left: 80, right: 80 },
            width: { size: Math.floor(9360 / item.headers.length), type: WidthType.DXA },
            children: [new Paragraph({
              alignment: ci > 0 ? AlignmentType.CENTER : AlignmentType.LEFT,
              children: [new TextRun({ text: cell, size: 18, font: 'Arial' })]
            })]
          }))
        }));
        paras.push(new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          columnWidths: Array(item.headers.length).fill(Math.floor(9360 / item.headers.length)),
          rows: [headerRow, ...dataRows]
        }));
      }
    });
  }

  sections.forEach((sec, si) => {
    if (si > 0) paras.push(new Paragraph({ children: [new PageBreak()] }));

    paras.push(new Paragraph({
      heading: HeadingLevel.HEADING_1,
      spacing: { after: 200 },
      children: [new TextRun({ text: sec.title, bold: true, size: 32, font: 'Arial' })]
    }));

    // Render main content
    renderItems(sec.content, false);

    // Conditionally append deep dive content
    if (includeDeepDives) {
      const ddItems = extractDeepDive(sec.id);
      if (ddItems.length > 0) {
        // Separator
        paras.push(new Paragraph({ spacing: { before: 360, after: 80 } }));
        // Deep Dive banner with teal shading
        paras.push(new Paragraph({
          spacing: { before: 0, after: 200 },
          shading: { fill: 'E0F7FA', type: ShadingType.CLEAR },
          indent: { left: 0, right: 0 },
          border: { left: { style: BorderStyle.SINGLE, size: 6, color: '1E6B71', space: 8 } },
          children: [
            new TextRun({ text: '  üìò  DEEP DIVE ‚Äî ', bold: true, size: 22, font: 'Arial', color: '1E6B71' }),
            new TextRun({ text: sec.title, bold: true, size: 22, font: 'Arial', color: '1E6B71', italics: true })
          ]
        }));
        renderItems(ddItems, true);
      }
    }
  });
  return paras;
}

function createDocxDocument(sections, includeDeepDives) {
  return new Document({
    styles: {
      default: { document: { run: { font: 'Arial', size: 22 } } },
      paragraphStyles: [
        { id: 'Heading1', name: 'Heading 1', basedOn: 'Normal', next: 'Normal', quickFormat: true,
          run: { size: 32, bold: true, font: 'Arial', color: '1E6B71' },
          paragraph: { spacing: { before: 240, after: 200 }, outlineLevel: 0 } },
        { id: 'Heading2', name: 'Heading 2', basedOn: 'Normal', next: 'Normal', quickFormat: true,
          run: { size: 26, bold: true, font: 'Arial', color: '334155' },
          paragraph: { spacing: { before: 180, after: 120 }, outlineLevel: 1 } },
      ]
    },
    numbering: {
      config: [
        { reference: 'bullets', levels: [{ level: 0, format: LevelFormat.BULLET, text: '\u2022', alignment: AlignmentType.LEFT,
          style: { paragraph: { indent: { left: 720, hanging: 360 } } } }] },
        { reference: 'numbers', levels: [{ level: 0, format: LevelFormat.DECIMAL, text: '%1.', alignment: AlignmentType.LEFT,
          style: { paragraph: { indent: { left: 720, hanging: 360 } } } }] },
      ]
    },
    sections: [{
      properties: {
        page: {
          size: { width: 12240, height: 15840 },
          margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
        }
      },
      headers: {
        default: new Header({ children: [new Paragraph({
          alignment: AlignmentType.RIGHT,
          children: [new TextRun({ text: 'Azure AD + Keycloak Federation Guide', size: 16, font: 'Arial', color: '94A3B8', italics: true })]
        })] })
      },
      footers: {
        default: new Footer({ children: [new Paragraph({
          alignment: AlignmentType.CENTER,
          children: [new TextRun({ text: 'Page ', size: 16, font: 'Arial', color: '94A3B8' }), new TextRun({ children: [PageNumber.CURRENT], size: 16, font: 'Arial', color: '94A3B8' })]
        })] })
      },
      children: buildDocxParagraphs(sections, null, includeDeepDives)
    }]
  });
}

async function downloadAll(btn, bySections) {
  const includeDeepDives = document.getElementById('include-deep-dives')?.checked || false;
  btn.classList.add('loading');
  try {
    if (bySections) {
      // Download each section as a separate file
      for (const sec of sectionData) {
        const doc = createDocxDocument([sec], includeDeepDives);
        const blob = await Packer.toBlob(doc);
        const safeName = sec.title.replace(/[^a-zA-Z0-9]+/g, '_').replace(/_+/g, '_');
        saveAs(blob, `${safeName}.docx`);
        await new Promise(r => setTimeout(r, 400)); // stagger downloads
      }
    } else {
      // Download all as one document
      const doc = createDocxDocument(sectionData, includeDeepDives);
      const blob = await Packer.toBlob(doc);
      const suffix = includeDeepDives ? '_with_Deep_Dives' : '';
      saveAs(blob, `Azure_AD_Keycloak_Federation_Complete_Guide${suffix}.docx`);
    }
  } catch (err) {
    console.error('Download error:', err);
    alert('Download failed. Please try again.');
  }
  btn.classList.remove('loading');
}

// Inject per-section download buttons into each section card header
document.querySelectorAll('.section-card').forEach(card => {
  const h2 = card.querySelector('h2');
  if (!h2) return;
  const sectionEl = card.closest('section');
  if (!sectionEl || !sectionEl.id) return;

  // Find matching section data
  const matchId = sectionEl.id;
  let matchedSections = sectionData.filter(s => s.id === matchId);
  if (!matchedSections.length) {
    // Try partial match for combined sections
    matchedSections = sectionData.filter(s => matchId.includes(s.id.split('-')[0]));
  }
  if (!matchedSections.length) return;

  const headerDiv = h2.parentElement;
  const dlBtn = document.createElement('button');
  dlBtn.className = 'dl-btn dl-btn-section ml-auto shrink-0';
  dlBtn.title = 'Download this section as .docx';
  dlBtn.innerHTML = `<div class="dl-spinner"></div><svg class="dl-icon w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg><span class="hidden sm:inline">.docx</span>`;
  dlBtn.onclick = async function() {
    const includeDD = document.getElementById('include-deep-dives')?.checked || false;
    this.classList.add('loading');
    try {
      const doc = createDocxDocument(matchedSections, includeDD);
      const blob = await Packer.toBlob(doc);
      const name = matchedSections[0].title.replace(/[^a-zA-Z0-9]+/g, '_');
      saveAs(blob, `${name}.docx`);
    } catch(e) { console.error(e); }
    this.classList.remove('loading');
  };

  // Make the header row a flex container and append button
  const wrapper = headerDiv.closest('.flex');
  if (wrapper) {
    wrapper.style.flexWrap = 'wrap';
    wrapper.appendChild(dlBtn);
  }
});
</script>
</body>
</html>